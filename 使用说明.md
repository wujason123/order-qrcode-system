# 订单二维码系统 - 使用说明

## 🎯 系统概述

本系统支持销售订单管理、库存管理、成本计算和BOM清单管理，重点功能包括：

1. **避免重复导入订单** - 智能检测重复订单号
2. **自动扣减原料库存** - 销售订单导入时根据BOM清单自动扣减原料
3. **库存实时监控** - 支持低库存预警和阈值设置
4. **成本自动计算** - 根据BOM和配置自动计算产品成本

## 🚀 启动系统

### 方法一：使用启动脚本（推荐）
```bash
双击运行: 启动系统.bat
或者: python run.py
```

### 方法二：手动启动
```bash
python app.py
```

## 📋 重要：避免重复导入问题

### ❌ 之前的问题
- 每次重启系统都会自动处理 `orders.xlsx` 文件
- 导致已有订单重复导入，系统报错

### ✅ 现在的解决方案
1. **系统启动时**：初始化数据库，智能检测Excel文件
2. **启动时处理**：可选择是否处理Excel并自动扣减库存
3. **Web上传**：在管理界面中上传Excel文件（自动扣减库存）

### 🎯 正确的使用流程

#### 日常使用（推荐）：
1. 如有新销售订单，准备Excel文件并重命名为 `orders.xlsx` 放在系统目录
2. 运行 `python run.py` 或双击 `启动系统.bat`
3. 选择 "1. 启动系统（智能检测Excel文件）"
4. 如果检测到Excel文件，系统会询问是否处理并自动扣减库存
5. 选择 y(是) 即可自动完成库存扣减，然后启动Web服务器

#### 首次使用：
1. 运行 `python run.py`
2. 选择 "1. 启动系统（智能检测Excel文件）"
3. 系统自动初始化示例数据并启动Web服务器
4. 访问 Web 界面进行操作

## 📦 库存扣减功能详解

### 🔄 自动扣减流程

当导入销售订单时，系统会：

1. **读取BOM清单**：获取产品需要的原料和数量
2. **检查库存充足性**：
   ```
   需求数量 = BOM中的单位需求 × 销售订单数量
   ```
3. **库存检查**：如果原料库存不足，订单导入失败并显示缺料信息
4. **自动扣减**：库存充足时，自动从原料库存中扣减相应数量
5. **记录交易**：在库存交易表中记录出库信息

### 📊 实例演示

**场景**：销售订单包含 2 台 PROD001（智能手机）

**BOM清单**：
- RAW001 (铝合金): 0.5kg/台
- PART001 (螺丝): 4个/台  
- PKG001 (包装盒): 1个/台

**自动计算**：
- 需要 RAW001: 0.5 × 2 = 1.0kg
- 需要 PART001: 4 × 2 = 8个
- 需要 PKG001: 1 × 2 = 2个

**库存扣减**：
```
RAW001: 700kg → 699kg (-1kg)
PART001: 2000个 → 1992个 (-8个)  
PKG001: 1000个 → 998个 (-2个)
```

## 📝 Excel文件格式要求

### 销售订单格式
| 订单号 | 客户姓名 | 订单日期 | 产品编码 | 产品名称 | 数量 | 销售单价 |
|--------|----------|----------|----------|----------|------|----------|
| ORD006 | 新客户   | 2024-01-20 | PROD001 | 智能手机 | 2 | 2200.00 |

### ⚠️ 注意事项
- 订单号必须唯一，不能与数据库中现有订单重复
- 产品编码必须在BOM清单中存在
- 数量必须为正数
- 所有必需字段不能为空

## 🔧 系统功能菜单

### 启动选项说明

#### 1. 启动系统（智能检测Excel文件）
- **功能**：初始化数据库 + 智能检测Excel + 自动扣减库存 + 启动Web服务器
- **流程**：检测到 orders.xlsx 时询问是否处理，选择"是"即自动扣减库存
- **适用**：日常使用，一站式完成所有操作
- **结果**：完整的系统功能，包含库存扣减

#### 2. 仅处理Excel销售订单数据
- **功能**：只处理 orders.xlsx，不启动Web服务器
- **适用**：只想导入数据，稍后再启动Web界面
- **前提**：确保有 orders.xlsx 文件且BOM清单已配置

#### 3. 仅启动Web服务器  
- **功能**：只启动Web界面，不处理Excel数据
- **适用**：数据已准备好，只需要Web功能
- **前提**：数据库文件存在

#### 4. 查看系统状态
- **功能**：检查文件完整性、订单数量、二维码数量
- **适用**：系统诊断和状态检查

## 📊 Web界面功能

### 📦 销售订单管理（重点功能）
- **智能上传**：上传销售订单Excel，系统自动扣减原料库存
- **BOM验证**：自动检查产品BOM清单，计算原料需求
- **库存检查**：库存不足时阻止导入并提示缺料信息
- **自动扣减**：根据BOM清单和销售数量自动扣减原料库存
- **盈亏计算**：自动计算每个订单的成本和盈亏状态

### 📊 库存管理
- **分类统计**：原材料、包装、配件、产品库存汇总
- **实时监控**：库存不足预警（红色）、库存偏低警告（黄色）
- **阈值设置**：可为每个物料设置低库存和警告阈值
- **库存操作**：支持产品入库、物料信息编辑

### 🔧 BOM管理
- **BOM清单**：按产品分组显示，支持展开/收缩
- **添加BOM**：物料编码按分类分组显示，便于选择
- **BOM编辑**：支持修改原料需求数量、单位、备注

### 📋 订单管理  
- **订单列表**：分页显示，支持搜索和删除
- **订单详情**：扫码或手动查询订单信息
- **打印功能**：Excel导出打印、网页直接打印

## 🚨 常见问题解决

### Q1：订单号重复错误
**问题**：`以下订单号在数据库中已存在: ORD001, ORD002`
**解决**：
1. 检查Excel中的订单号是否与现有订单重复
2. 使用新的订单号，或者在Web界面删除旧订单
3. 确保Excel文件中订单号唯一

### Q2：原料库存不足
**问题**：`订单 ORD006 的原料库存不足: RAW001: 需要1.0千克, 库存0.5千克`
**解决**：
1. 先处理采购订单补充原料库存
2. 或者减少销售订单中的产品数量
3. 检查BOM清单中的需求数量是否正确

### Q3：产品没有BOM清单
**问题**：销售订单中的产品在BOM表中不存在
**解决**：
1. 在Web界面的BOM管理中添加产品的BOM清单
2. 或者上传BOM Excel文件
3. 确保产品编码在销售订单和BOM中一致

### Q4：无法生成二维码
**问题**：数据导入成功但二维码生成失败  
**解决**：
1. 检查 qrcodes 目录权限
2. 确保网络配置正确（IP地址可访问）
3. 检查系统日志中的具体错误信息

## 💡 最佳实践建议

### 1. 数据准备流程
1. **配置BOM清单** → 2. **初始库存导入** → 3. **销售订单导入**

### 2. 库存管理
- 定期检查库存状态，及时补充低库存物料
- 设置合理的库存阈值，避免缺料影响生产
- 使用库存交易记录追踪物料流动

### 3. 订单处理
- 每次处理新订单前，确认库存充足
- 保持订单号的唯一性和规范性
- 定期备份订单数据和二维码文件

### 4. 系统维护
- 定期检查系统状态（选项4）
- 备份 orders.db 数据库文件
- 清理过期的上传文件

## 📞 技术支持

如有问题，请检查：
1. 系统状态（run.py 选项4）
2. 控制台错误信息
3. 数据库文件完整性
4. Excel文件格式规范性

---

**版本**：v2.0.0  
**更新时间**：2024年12月  
**重要更新**：解决重复导入问题，完善库存扣减功能 