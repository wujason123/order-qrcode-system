# 🏭 库存管理业务流程说明

## 📋 业务流程概览

本系统实现了完整的**销售订单→成品库存扣减→生产订单→原料库存扣减**的业务流程。

## 🎯 核心业务逻辑

### 第一阶段：销售订单处理
```
销售订单 → 扣减成品库存 → 生成库存交易记录
```

### 第二阶段：生产订单处理  
```
销售需求汇总 → 生产订单 → 扣减原料库存 → 生成库存交易记录
```

## 🔄 详细流程步骤

### 步骤1：导入销售订单
- 📁 通过Web界面上传Excel文件或启动时自动处理
- 📊 系统自动读取订单信息（订单号、产品编码、数量等）
- ✅ 验证订单格式和重复性

### 步骤2：自动扣减成品库存
- 🎯 **业务规则**: 销售订单直接扣减对应成品的库存
- 📦 检查成品库存是否充足（允许负库存，仅警告）
- 📝 记录成品出库交易：`PROD001: out +2.0 - 销售订单 ORD001 出库`
- 🔄 更新成品库存数量

### 步骤3：转换为生产订单
- 📊 汇总所有销售订单的产品需求
- 🏭 按产品类型生成生产订单
- 📋 根据BOM清单计算原料需求

### 步骤4：自动扣减原料库存
- 🎯 **业务规则**: 生产订单扣减BOM中配置的原料库存
- 🔧 根据BOM配方计算总原料需求：
  ```
  PROD001 × 4件 需要：
  - RAW001: 2.5 × 4 = 10.0 公斤
  - PKG001: 1.0 × 4 = 4.0 个  
  - PART001: 4.0 × 4 = 16.0 个
  ```
- 📝 记录原料出库交易：`RAW001: 生产出库 -10.0 - 生产订单原料消耗`
- 🔄 更新原料库存数量

## 📊 数据流示例

### 销售订单数据
```
ORD001: PROD001 × 1 (张三)
ORD002: PROD002 × 1 (李四)  
ORD003: PROD001 × 2 (王五)
```

### 成品库存变化
```
销售前: PROD001=31.0, PROD002=9.0
销售后: PROD001=28.0, PROD002=8.0  
变化: PROD001(-3), PROD002(-1)
```

### 原料库存变化
```
生产前: RAW001=90.0, PKG001=500.0, PART001=1000.0
生产后: RAW001=76.4, PKG001=494.0, PART001=984.0
变化: RAW001(-13.6), PKG001(-6.0), PART001(-16.0)
```

## 🔧 技术实现

### 核心文件
- `excel_processor.py`: 处理销售订单，扣减成品库存
- `production_order_manager.py`: 处理生产订单，扣减原料库存
- `verify_inventory_flow.py`: 验证整个业务流程

### 数据库表结构
- `orders`: 销售订单表
- `inventory_items`: 库存主表（原料+成品）
- `inventory_transactions`: 库存交易记录表
- `bom_items`: BOM清单表

## 🚀 使用方法

### 方法一：Web界面操作
1. 启动系统：`python run.py`
2. 访问：`http://localhost:5000`
3. 登录后上传Excel订单文件
4. 系统自动处理两个阶段的库存扣减

### 方法二：独立运行生产订单
```bash
# 处理当前数据库中的所有销售订单
python production_order_manager.py
```

### 方法三：验证业务流程
```bash
# 查看完整的业务流程报告
python verify_inventory_flow.py
```

## ⚠️ 重要业务规则

### 1. 库存扣减顺序
```
✅ 正确: 销售订单→成品库存→生产订单→原料库存
❌ 错误: 销售订单→原料库存（之前的错误逻辑）
```

### 2. 负库存处理
- ✅ **允许负库存**: 系统不阻止订单导入
- ⚠️ **警告提示**: 显示库存不足警告
- 📝 **记录完整**: 所有交易都有完整记录

### 3. 成本计算
- 💰 使用扣减后的库存数量进行成本计算
- ⚠️ 成本计算失败不影响库存扣减
- 📊 成本计算独立于库存管理

## 🎉 验证成功标志

运行验证脚本后，看到以下输出说明系统运行正常：
```
🎯 完整业务流程:
   ✅ 步骤1: 导入销售订单
   ✅ 步骤2: 自动扣减成品库存  
   ✅ 步骤3: 转换为生产订单
   ✅ 步骤4: 自动扣减原料库存
   ✅ 步骤5: 生成库存交易记录

🎉 库存管理系统运行正常！
```

## 🔍 故障排查

### 常见问题
1. **Excel格式错误**: 使用"下载模板"功能获取正确格式
2. **数据库连接**: 确保`orders.db`存在且可访问
3. **BOM配置**: 检查`bom_items`表是否有对应产品的配方

### 调试工具
- `check_status.py`: 检查数据库状态
- `verify_inventory_flow.py`: 验证完整流程
- Web界面库存报表：实时查看库存状态 