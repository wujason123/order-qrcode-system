<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单查询系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .card {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            border-radius: 15px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
        }
        
        .order-card {
            transition: transform 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .order-card:hover {
            transform: translateY(-5px);
        }
        
        .amount {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .order-id {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 8px;
            font-family: monospace;
            border-left: 4px solid #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        
        .error-message {
            background: #ffe6e6;
            border: 1px solid #ff9999;
            color: #cc0000;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .success-message {
            background: #e6ffe6;
            border: 1px solid #99ff99;
            color: #006600;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box .form-control {
            padding-left: 3rem;
            border-radius: 25px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .search-box .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* 移动端优化样式 */
        @media (max-width: 768px) {
            .card-body .table {
                font-size: 14px;
            }
            
            .card-header h4 {
                font-size: 1.3rem;
            }
            
            .table td {
                padding: 12px 8px !important;
                word-break: break-word;
            }
            
            .table td:first-child {
                width: 30% !important;
                font-size: 13px;
            }
            
            .table td:last-child {
                font-size: 16px;
            }
            
            .btn-group .btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
        
        /* Excel表格样式增强 */
        .excel-table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .excel-table td {
            position: relative;
        }
        
        .excel-table .table-active {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        }
        
        /* 图标颜色样式 */
        .text-purple {
            color: #6f42c1 !important;
        }
        
        /* 订单详情页面专用样式 */
        .order-details-card {
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            border: none;
            border-radius: 20px;
            overflow: hidden;
        }
        
        .order-details-card .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px;
        }
        
        /* 表格行悬停效果 */
        .excel-table tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        /* 操作按钮优化 */
        .action-buttons .btn {
            margin: 0 5px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }
        
        .action-buttons .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .loading p {
            margin-bottom: 0;
            color: #6c757d;
        }
        
        /* 库存分类卡片悬停效果 */
        .cursor-pointer:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .cursor-pointer {
            transition: all 0.3s ease;
        }
        
        .cursor-pointer:hover .card-body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        /* 添加一些样式来优化饼图显示 */
        .cost-chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }

        .cost-summary {
            font-size: 0.9em;
        }

        .cost-percentage {
            font-size: 0.8em;
            color: #6c757d;
        }

        /* 自定义饼图颜色 */
        :root {
            --chart-color-material: #FF6384;    /* 红色 - 材料成本 */
            --chart-color-labor: #36A2EB;       /* 蓝色 - 人工成本 */
            --chart-color-management: #FFCE56;   /* 黄色 - 管理成本 */
            --chart-color-transport: #4BC0C0;    /* 青色 - 运输成本 */
            --chart-color-other: #9966FF;        /* 紫色 - 其他成本 */
        }

        /* 为成本项添加对应的颜色标识 */
        .cost-item-material { color: var(--chart-color-material); }
        .cost-item-labor { color: var(--chart-color-labor); }
        .cost-item-management { color: var(--chart-color-management); }
        .cost-item-transport { color: var(--chart-color-transport); }
        .cost-item-other { color: var(--chart-color-other); }

        .cursor-pointer {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cursor-pointer:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        .category-toggle {
            transition: transform 0.3s ease;
        }
        
        .category-toggle.bi-chevron-up {
            transform: rotate(-180deg);
        }
        
        .collapse {
            transition: all 0.3s ease;
        }
        
        .card-header {
            border-bottom: none;
        }
        
        .collapse:not(.show) {
            display: none;
        }
        
        .collapse.show {
            display: block;
        }
        
        .table th {
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .badge {
            font-weight: 500;
        }
        
        .text-end {
            text-align: right !important;
        }
        
        .text-center {
            text-align: center !important;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- 页面标题 -->
        <div class="text-center mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div></div> <!-- 占位元素 -->
                <h1 class="text-white mb-0">
                    <i class="bi bi-qr-code"></i> 订单查询系统
                </h1>
                <!-- 用户信息和登出按钮 -->
                {% if session.logged_in %}
                <div class="dropdown">
                    <button class="btn btn-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> {{ session.username }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><span class="dropdown-item-text"><i class="bi bi-info-circle"></i> 管理员身份</span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> 退出登录</a></li>
                    </ul>
                </div>
                {% else %}
                <a href="{{ url_for('login') }}" class="btn btn-light btn-sm">
                    <i class="bi bi-box-arrow-in-right"></i> 登录
                </a>
                {% endif %}
            </div>
            <p class="text-white-50">扫描二维码或输入订单号查询订单详情</p>
        </div>

        <!-- Excel文件上传区域 - 仅管理员可见 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cloud-upload"></i> 导入Excel文件
                </h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">选择Excel文件</label>
                        <input type="file" class="form-control" id="excelFile" name="file" 
                               accept=".xlsx,.xls" required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            支持 .xlsx 和 .xls 格式，<strong>新格式需包含：</strong>订单号、客户姓名、订单日期、<span class="text-primary">产品编码、产品名称、数量、销售单价</span>（支持自动盈亏计算）
                            <br>
                            <a href="/download/template" class="text-decoration-none">
                                <i class="bi bi-download"></i> 下载Excel模板文件
                            </a>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">
                            <i class="bi bi-upload"></i> 上传并生成二维码
                        </button>
                    </div>
                </form>
                <div id="uploadProgress" style="display: none;" class="mt-3">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                        <span>正在处理文件...</span>
                    </div>
                    <div class="progress mt-2">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
                <div id="uploadResult"></div>
            </div>
        </div>

        <!-- 仓储成本管理系统 - 新增功能区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-boxes"></i> 仓储成本管理系统
                </h5>
            </div>
            <div class="card-body">
                <!-- 功能导航标签 -->
                <ul class="nav nav-pills mb-3" id="costManagementTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="purchase-tab" data-bs-toggle="pill" 
                                data-bs-target="#purchase" type="button" role="tab">
                            <i class="bi bi-cart-plus"></i> 采购导入
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="bom-tab" data-bs-toggle="pill" 
                                data-bs-target="#bom" type="button" role="tab">
                            <i class="bi bi-diagram-3"></i> BOM管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-tab" data-bs-toggle="pill" 
                                data-bs-target="#inventory" type="button" role="tab">
                            <i class="bi bi-boxes"></i> 库存查看
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cost-tab" data-bs-toggle="pill" 
                                data-bs-target="#cost" type="button" role="tab">
                            <i class="bi bi-calculator"></i> 成本计算
                        </button>
                    </li>
                </ul>

                <!-- 标签页内容 -->
                <div class="tab-content" id="costManagementTabsContent">
                    <!-- 采购订单导入 -->
                    <div class="tab-pane fade show active" id="purchase" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <form id="purchaseUploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="purchaseFile" class="form-label">上传采购订单Excel</label>
                                        <input type="file" class="form-control" id="purchaseFile" name="file" 
                                               accept=".xlsx,.xls" required>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> 
                                            需包含：采购单号、物品编码、物品名称、供应商、采购日期、数量、单价等字段
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-upload"></i> 导入采购订单
                                    </button>
                                    <a href="/download/purchase_template" class="btn btn-outline-secondary ms-2">
                                        <i class="bi bi-download"></i> 下载模板
                                    </a>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-lightbulb"></i> 采购导入说明</h6>
                                    <ul class="mb-0 small">
                                        <li>自动更新库存数量</li>
                                        <li>计算加权平均价格</li>
                                        <li>支持多供应商价格管理</li>
                                        <li>自动记录采购历史</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="purchaseUploadResult" class="mt-3"></div>
                    </div>

                    <!-- BOM物料清单管理 -->
                    <div class="tab-pane fade" id="bom" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <form id="bomUploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="bomFile" class="form-label">上传BOM物料清单Excel</label>
                                        <input type="file" class="form-control" id="bomFile" name="file" 
                                               accept=".xlsx,.xls" required>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle"></i> 
                                            需包含：产品编码、原料编码、需求数量、单位等字段
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-upload"></i> 导入BOM清单
                                    </button>
                                    <a href="/download/bom_template" class="btn btn-outline-secondary ms-2">
                                        <i class="bi bi-download"></i> 下载模板
                                    </a>
                                </form>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-diagram-3"></i> BOM管理说明</h6>
                                    <ul class="mb-0 small">
                                        <li>定义产品与原料的关系</li>
                                        <li>支持多级BOM结构</li>
                                        <li>自动计算材料成本</li>
                                        <li>检查库存是否充足</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div id="bomUploadResult" class="mt-3"></div>
                        
                        <!-- 当前BOM清单 -->
                        <div class="card mt-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6><i class="bi bi-list-ul"></i> 当前BOM清单</h6>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="loadBomList()" title="刷新BOM数据">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="showAddBomModal()" title="添加BOM项目">
                                        <i class="bi bi-plus"></i> 添加
                                    </button>
                                </div>
                            </div>
                            <div class="card-body" id="bomListContainer">
                                <div class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    加载BOM数据...
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 库存管理 -->
                    <div class="tab-pane fade" id="inventory" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="bi bi-boxes"></i> 库存汇总</h6>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="showProductStockModal()">
                                    <i class="bi bi-box-arrow-in-down"></i> 产品入库
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadInventorySummary()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                </button>
                            </div>
                        </div>
                        
                        <!-- 库存汇总卡片 -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-white p-3 me-3">
                                                <i class="bi bi-box text-primary" style="font-size: 2rem;"></i>
                                            </div>
                                            <div>
                                                <h3 class="card-title mb-0" id="totalItems">-</h3>
                                                <div class="text-white-50">物品种类</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-white p-3 me-3">
                                                <i class="bi bi-boxes text-success" style="font-size: 2rem;"></i>
                                            </div>
                                            <div>
                                                <h3 class="card-title mb-0" id="totalStock">-</h3>
                                                <div class="text-white-50">总库存量</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-white p-3 me-3">
                                                <i class="bi bi-currency-yen text-warning" style="font-size: 2rem;"></i>
                                            </div>
                                            <div>
                                                <h3 class="card-title mb-0" id="totalValue">-</h3>
                                                <div class="text-white-50">库存总值</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 分类库存统计 -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="bi bi-grid"></i> 分类库存统计</h6>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="loadInventorySummary()">
                                            <i class="bi bi-arrow-clockwise"></i> 刷新
                                        </button>
                                    </div>
                                    <div class="card-body" id="categoryStats">
                                        <div class="text-center">
                                            <div class="spinner-border spinner-border-sm"></div>
                                            <p class="text-muted mt-2">加载库存数据...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> 库存不足提醒</h6>
                                    </div>
                                    <div class="card-body" id="lowStockItems">
                                        <div class="text-center">
                                            <div class="spinner-border spinner-border-sm"></div>
                                            <p class="text-muted mt-2">加载预警数据...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 物料详情模态框 -->
                        <div class="card mt-4" id="inventoryDetailsCard" style="display: none;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 id="inventoryDetailsTitle"><i class="bi bi-box-seam"></i> 物料详情</h6>
                                <button class="btn btn-outline-secondary btn-sm" onclick="hideInventoryDetails()">
                                    <i class="bi bi-x"></i> 关闭
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="inventoryDetailsContainer">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm"></div>
                                        <span class="ms-2">加载物料详情...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 成本计算 -->
                    <div class="tab-pane fade" id="cost" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <!-- 成本计算器 -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="bi bi-calculator"></i> 产品成本计算器</h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="costCalculationForm" onsubmit="calculateCost(event)">
                                            <div class="mb-3">
                                                <label for="productCode" class="form-label">产品编码</label>
                                                <select class="form-select" id="productCode" name="productCode" required>
                                                    <option value="">请选择产品</option>
                                                </select>
                                                <div class="form-text">只显示已有BOM清单的产品</div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label for="quantity" class="form-label">生产数量</label>
                                                        <input type="number" class="form-control" id="quantity" 
                                                               name="quantity" value="1" min="1" step="1" required>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label for="laborHours" class="form-label">人工工时</label>
                                                        <input type="number" class="form-control" id="laborHours" 
                                                               name="laborHours" value="0" min="0" step="0.5" required>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary btn-lg">
                                                    <i class="bi bi-calculator"></i> 计算成本
                                                </button>
                                            </div>
                                        </form>
                                        <div id="costResult" class="mt-4"></div>
                                    </div>
                                </div>

                                <!-- 成本配置项管理 -->
                                <div class="card mt-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6><i class="bi bi-gear"></i> 成本配置项</h6>
                                        <div>
                                            <button class="btn btn-sm btn-secondary me-2" onclick="loadCostConfigItems()">
                                                <i class="bi bi-arrow-clockwise"></i> 刷新
                                            </button>
                                            <button class="btn btn-sm btn-primary" onclick="showAddCostConfigModal()">
                                                <i class="bi bi-plus"></i> 添加配置项
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body" id="costConfigItemsContainer">
                                        <div class="loading text-center">
                                            <div class="spinner-border spinner-border-sm"></div>
                                            <small class="text-muted ms-2">加载配置项...</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- 已计算产品成本列表 -->
                                <div class="card mt-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6><i class="bi bi-list-check"></i> 已计算产品成本</h6>
                                        <button class="btn btn-sm btn-secondary" onclick="loadProductCosts()">
                                            <i class="bi bi-arrow-clockwise"></i> 刷新
                                        </button>
                                    </div>
                                    <div class="card-body" id="productCostsContainer">
                                        <div class="loading text-center">
                                            <div class="spinner-border spinner-border-sm"></div>
                                            <small class="text-muted ms-2">加载成本记录...</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <!-- 成本分析报告 -->
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-pie-chart-fill"></i> 成本分析报告
                                        </h6>
                                        <button class="btn btn-sm btn-secondary btn-refresh" onclick="loadProductCosts()">
                                            <i class="bi bi-arrow-clockwise"></i> 刷新
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <!-- 产品选择 -->
                                        <div class="mb-3">
                                            <select class="form-select cost-analysis-select">
                                                <option value="">请选择产品...</option>
                                            </select>
                                        </div>
                                        <div id="costAnalysisContainer">
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle"></i> 
                                                请选择要查看的产品
                                    </div>
                                </div>
                                    </div>
                                </div>
                                
                                <!-- 销售订单盈亏报告 -->
                                <div class="card mt-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-graph-up"></i> 销售订单盈亏报告
                                        </h6>
                                        <button class="btn btn-sm btn-secondary" onclick="loadOrderProfitReport()">
                                            <i class="bi bi-arrow-clockwise"></i> 刷新
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label class="form-label">时间范围</label>
                                                <div class="input-group">
                                                    <input type="date" class="form-control form-control-sm" id="profitStartDate">
                                                    <span class="input-group-text">至</span>
                                                    <input type="date" class="form-control form-control-sm" id="profitEndDate">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">产品</label>
                                                <div class="profit-product-select-container">
                                                    <select class="form-select form-select-sm profit-product-select">
                                                        <option value="">全部产品</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-primary btn-sm w-100" onclick="loadOrderProfitReport()">
                                                    <i class="bi bi-search"></i> 查询
                                                </button>
                                            </div>
                                        </div>
                                        <div id="orderProfitReport">
                                            <div class="loading text-center">
                                                <div class="spinner-border spinner-border-sm"></div>
                                                <small class="text-muted ms-2">加载盈亏数据...</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 使用说明区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> 使用说明
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="p-3">
                            <i class="bi bi-cloud-upload text-primary" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">1. 上传Excel</h6>
                            <p class="small text-muted">上传包含订单信息的Excel文件</p>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="p-3">
                            <i class="bi bi-qr-code text-success" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">2. 生成二维码</h6>
                            <p class="small text-muted">系统自动为每个订单生成二维码</p>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="p-3">
                            <i class="bi bi-phone text-info" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">3. 手机扫码</h6>
                            <p class="small text-muted">用手机扫描二维码查看订单详情</p>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mb-0">
                    <i class="bi bi-lightbulb"></i> 
                    <strong>提示：</strong>手机扫描二维码后会自动打开浏览器显示订单详情，无需在此页面扫描
                </div>
            </div>
        </div>

        <!-- 手动查询区域 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-search"></i> 手动查询订单
                </h5>
            </div>
            <div class="card-body">
                <div class="search-box">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="form-control" id="searchOrderId" 
                           placeholder="请输入订单号（例如：ORD001）">
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="searchOrder()">
                        <i class="bi bi-search"></i> 查询订单
                    </button>
                </div>
            </div>
        </div>

        <!-- 订单详情显示区域 -->
        <div id="orderResult" style="display: none;"></div>

        <!-- 所有订单列表 - 仅管理员可见 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> 所有订单列表
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <span id="ordersCount" class="badge bg-primary"></span>
                    
                    <!-- 打印功能按钮组 -->
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAllPrintCheckboxes()" title="全选/取消全选">
                            <i class="bi bi-check2-all"></i> 全选
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="exportToExcel()" title="导出Excel打印">
                            <i class="bi bi-file-earmark-excel"></i> Excel打印
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="openPrintPreview()" title="网页打印预览">
                            <i class="bi bi-printer"></i> 网页打印
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="ordersList">
                    <div class="loading">
                        <div class="spinner-border spinner text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2 text-muted">正在加载订单列表...</p>
                    </div>
                </div>
                
                <!-- 分页导航 -->
                <nav aria-label="订单列表分页" id="paginationNav" style="display: none;">
                    <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
                </nav>
            </div>
        </div>

        <!-- 页脚 -->
        <div class="text-center mt-4 text-white-50">
            <p><i class="bi bi-info-circle"></i> 订单二维码查询系统 v1.0.0</p>
        </div>
    </div>

    <!-- 阈值设置模态框 -->
    <div class="modal fade" id="thresholdModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-sliders"></i> 设置库存阈值
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="thresholdForm">
                        <input type="hidden" id="thresholdItemCode">
                        <div class="mb-3">
                            <label for="lowStockThreshold" class="form-label">低库存阈值</label>
                            <input type="number" class="form-control" id="lowStockThreshold" required min="0">
                            <div class="form-text">当库存低于此值时显示红色警告</div>
                        </div>
                        <div class="mb-3">
                            <label for="warningStockThreshold" class="form-label">警告库存阈值</label>
                            <input type="number" class="form-control" id="warningStockThreshold" required min="0">
                            <div class="form-text">当库存低于此值时显示黄色警告</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveThresholds()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 物料编辑模态框 -->
    <div class="modal fade" id="inventoryItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil"></i> 编辑物料信息
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inventoryItemForm">
                        <input type="hidden" id="editItemCode">
                        <div class="mb-3">
                            <label for="editItemName" class="form-label">物料名称</label>
                            <input type="text" class="form-control" id="editItemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editItemUnit" class="form-label">单位</label>
                            <input type="text" class="form-control" id="editItemUnit" required>
                        </div>
                        <div class="mb-3">
                            <label for="editItemCategory" class="form-label">分类</label>
                            <select class="form-control" id="editItemCategory" required>
                                <option value="原材料">原材料</option>
                                <option value="包装">包装</option>
                                <option value="配件">配件</option>
                                <option value="产品">产品</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveInventoryItem()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BOM编辑模态框 -->
    <div class="modal fade" id="bomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bomModalTitle">
                        <i class="bi bi-plus-circle"></i> 添加BOM项目
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bomForm">
                        <input type="hidden" id="bomId" name="id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="productCode" class="form-label">产品编码</label>
                                    <input type="text" class="form-control" id="productCode" name="product_code" required>
                                    <div class="form-text">如: PROD001</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="materialCode" class="form-label">原料编码</label>
                                    <select class="form-control" id="materialCode" name="material_code" required onchange="onMaterialChange()">
                                        <option value="">请选择原料</option>
                                    </select>
                                    <div class="form-text">选择已有的原料，单位和备注将自动填充</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="requiredQuantity" class="form-label">需求数量</label>
                                    <input type="number" step="0.01" class="form-control" id="requiredQuantity" name="required_quantity" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="unit" class="form-label">单位</label>
                                    <input type="text" class="form-control" id="unit" name="unit" list="unitOptions" placeholder="自动填充或手动输入">
                                    <datalist id="unitOptions">
                                        <option value="个">个</option>
                                        <option value="公斤">公斤</option>
                                        <option value="kg">kg</option>
                                        <option value="克">克</option>
                                        <option value="米">米</option>
                                        <option value="套">套</option>
                                        <option value="张">张</option>
                                        <option value="只">只</option>
                                        <option value="片">片</option>
                                        <option value="盒">盒</option>
                                        <option value="瓶">瓶</option>
                                        <option value="包">包</option>
                                    </datalist>
                                    <div class="form-text">选择原料时会自动填充，也可手动修改</div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">备注</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="选择原料时会自动填充原料名称，也可手动修改"></textarea>
                            <div class="form-text">备注信息将有助于区分不同用途的同一原料</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBomItem()">
                        <i class="bi bi-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 成本配置项添加/编辑模态框 -->
    <div class="modal fade" id="costConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="costConfigModalTitle">添加成本配置项</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="costConfigForm">
                        <input type="hidden" id="costConfigId">
                        <div class="mb-3">
                            <label for="configName" class="form-label">配置项名称</label>
                            <input type="text" class="form-control" id="configName" required>
                            <div class="form-text">如：人工费率、管理费率等</div>
                        </div>
                        <div class="mb-3">
                            <label for="configType" class="form-label">配置项类型</label>
                            <select class="form-control" id="configType" required>
                                <option value="percentage">百分比</option>
                                <option value="fixed">固定值</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="configValue" class="form-label">默认值</label>
                            <input type="number" class="form-control" id="configValue" required step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="configUnit" class="form-label">单位</label>
                            <input type="text" class="form-control" id="configUnit" required>
                            <div class="form-text">如：%、元/小时等</div>
                        </div>
                        <div class="mb-3">
                            <label for="configDescription" class="form-label">说明</label>
                            <textarea class="form-control" id="configDescription" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCostConfig()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加必要的JavaScript库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let allOrders = []; // 存储所有订单数据
        let currentPage = 1; // 当前页码
        const ordersPerPage = 9; // 每页显示订单数
        
        // 页面加载时获取订单列表
        document.addEventListener('DOMContentLoaded', function() {
            loadAllOrders();
            
            // 检查URL参数是否有订单号
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            if (orderId) {
                document.getElementById('searchOrderId').value = orderId;
                searchOrder();
            }
            
            // 回车键搜索
            document.getElementById('searchOrderId').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchOrder();
                }
            });

            // 文件上传表单处理
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadExcelFile();
            });

            // 绑定采购订单上传表单
            document.getElementById('purchaseUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadPurchaseFile();
            });

            // 绑定BOM上传表单
            document.getElementById('bomUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadBomFile();
            });

            // 成本计算函数
            async function calculateProductCost(event) {
                event.preventDefault();
                
                const productCode = document.getElementById('productCode').value;
                const quantity = parseFloat(document.getElementById('quantity').value);
                const laborHours = parseFloat(document.getElementById('laborHours').value);
                
                if (!productCode) {
                    showAlert('danger', '请选择产品');
                    return;
                }
                
                try {
                    // 显示加载状态
                    const resultDiv = document.getElementById('costResult');
                    resultDiv.innerHTML = `
                        <div class="text-center">
                            <div class="spinner-border spinner-border-sm"></div>
                            <p class="text-muted mt-2">正在计算成本...</p>
                        </div>
                    `;
                    
                    const response = await fetch('/api/calculate_product_cost', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            product_code: productCode,
                            quantity: quantity,
                            labor_hours: laborHours
                        })
                    });
                    
                    const result = await response.json();
                    console.log('成本计算结果:', result);
                    
                    if (result.success) {
                        displayCostResult(result.cost);
                        showAlert('success', '成本计算完成');
                    } else {
                        resultDiv.innerHTML = '';
                        showAlert('danger', result.error || '计算失败');
                    }
                } catch (error) {
                    console.error('成本计算错误:', error);
                    document.getElementById('costResult').innerHTML = '';
                    showAlert('danger', '计算失败: ' + error.message);
                }
            }

            // 标签页切换事件
            const tabTriggers = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabTriggers.forEach(trigger => {
                trigger.addEventListener('shown.bs.tab', function (event) {
                    const activeTab = event.target.getAttribute('data-bs-target');
                    console.log('切换到标签页:', activeTab);
                    
                    if (activeTab === '#inventory') {
                        console.log('加载库存数据...');
                        loadInventorySummary();
                    } else if (activeTab === '#cost') {
                        console.log('加载成本数据...');
                        loadProductList();
                        loadCostConfigItems();
                        loadProductCosts();
                    } else if (activeTab === '#bom') {
                        console.log('加载BOM数据...');
                        loadBomList();
                    }
                });
            });

            // 加载库存汇总信息
            loadInventorySummary();
            
            // 加载成本分析
            loadCostAnalysis();
            
            // 初始检查活动标签页并加载对应数据
            const initialActiveTab = document.querySelector('.nav-link.active');
            if (initialActiveTab) {
                const targetTab = initialActiveTab.getAttribute('data-bs-target');
                console.log('初始活动标签页:', targetTab);
                if (targetTab === '#bom') {
                    console.log('初始加载BOM数据...');
                    loadBomList();
                } else if (targetTab === '#cost') {
                    console.log('初始加载成本数据...');
                    loadProductList();
                    loadCostConfigItems();
                    loadProductCosts();
                }
            }
        });

        // 搜索指定订单
        async function searchOrder() {
            const orderId = document.getElementById('searchOrderId').value.trim();
            if (!orderId) {
                showError('请输入订单号');
                return;
            }

            const resultDiv = document.getElementById('orderResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="loading">
                            <div class="spinner-border spinner text-primary" role="status"></div>
                            <p class="mt-2 text-muted">正在查询订单 ${orderId}...</p>
                        </div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`/order?order_id=${encodeURIComponent(orderId)}`);
                const data = await response.json();

                if (data.success) {
                    displayOrderDetails(data.data);
                } else {
                    showError(data.message || '查询失败');
                }
            } catch (error) {
                console.error('查询错误:', error);
                showError('网络错误，请检查连接');
            }
        }

        // 显示订单详情
        function displayOrderDetails(order) {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.innerHTML = `
                <div class="card order-details-card">
                    <div class="card-header text-center">
                        <h4 class="mb-0">
                            <i class="bi bi-receipt"></i> 订单查询结果
                        </h4>
                    </div>
                    <div class="card-body p-0">
                        <!-- Excel表格样式显示 -->
                        <div class="table-responsive">
                            <table class="table table-bordered excel-table mb-0" style="font-size: 16px;">
                                <tbody>
                                    <tr>
                                        <td class="table-active fw-bold text-center" style="width: 30%; background-color: #f8f9fa; border: 2px solid #dee2e6; vertical-align: middle;">
                                            <i class="bi bi-tag text-primary"></i><br>
                                            <small>订单号</small>
                                        </td>
                                        <td class="text-center fw-bold" style="font-family: 'Courier New', monospace; font-size: 20px; color: #0066cc; border: 2px solid #dee2e6; background: #fff; vertical-align: middle;">
                                            ${order.order_id}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="table-active fw-bold text-center" style="background-color: #f8f9fa; border: 2px solid #dee2e6; vertical-align: middle;">
                                            <i class="bi bi-person text-success"></i><br>
                                            <small>客户姓名</small>
                                        </td>
                                        <td class="text-center" style="font-size: 18px; color: #333; border: 2px solid #dee2e6; background: #fff; vertical-align: middle; font-weight: 500;">
                                            ${order.customer_name}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="table-active fw-bold text-center" style="background-color: #f8f9fa; border: 2px solid #dee2e6; vertical-align: middle;">
                                            <i class="bi bi-calendar text-info"></i><br>
                                            <small>订单日期</small>
                                        </td>
                                        <td class="text-center" style="font-size: 18px; color: #333; border: 2px solid #dee2e6; background: #fff; vertical-align: middle; font-weight: 500;">
                                            ${order.order_date}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="table-active fw-bold text-center" style="background-color: #f8f9fa; border: 2px solid #dee2e6; vertical-align: middle;">
                                            <i class="bi bi-currency-yen text-warning"></i><br>
                                            <small>金额</small>
                                        </td>
                                        <td class="text-center fw-bold" style="font-size: 22px; color: #e74c3c; border: 2px solid #dee2e6; background: #fff9f9; vertical-align: middle; font-family: 'Arial Black', sans-serif;">
                                            ¥${parseFloat(order.amount).toFixed(2)}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="table-active fw-bold text-center" style="background-color: #f8f9fa; border: 2px solid #dee2e6; vertical-align: top; padding-top: 20px;">
                                            <i class="bi bi-box text-purple"></i><br>
                                            <small>产品详情</small>
                                        </td>
                                        <td style="border: 2px solid #dee2e6; padding: 20px; line-height: 1.8; background: #fff;">
                                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; font-size: 16px; text-align: left;">
                                                ${order.product_details}
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 二维码区域 -->
                        <div class="text-center p-4 border-top" style="background-color: #f8f9fa;">
                            <div style="display: inline-block; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <img src="/qrcode/${order.order_id}" 
                                     class="img-fluid" 
                                     style="max-width: 150px; border: 1px solid #ddd; border-radius: 8px;"
                                     alt="订单二维码"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <div style="display: none;" class="text-muted">
                                    <i class="bi bi-exclamation-triangle"></i> 二维码不可用
                                </div>
                            </div>
                            <p class="small text-muted mt-2 mb-0">
                                <i class="bi bi-qr-code"></i> 订单专用二维码
                            </p>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="text-center p-3 border-top action-buttons">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="window.location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="window.history.back()">
                                    <i class="bi bi-arrow-left"></i> 返回
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="shareOrder('${order.order_id}')">
                                    <i class="bi bi-share"></i> 分享
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 移动端优化提示 -->
                <div class="d-block d-md-none mt-3">
                    <div class="alert alert-info">
                        <i class="bi bi-phone"></i> 
                        <strong>手机查看提示：</strong> 可以截图保存此订单信息，或点击"分享"按钮发送给他人
                    </div>
                </div>
            `;
        }

        // 加载所有订单
        async function loadAllOrders() {
            try {
                const response = await fetch('/orders');
                const data = await response.json();

                if (data.success) {
                    allOrders = data.data; // 存储所有订单数据
                    currentPage = 1; // 重置到第一页
                    displayOrdersList();
                } else {
                    document.getElementById('ordersList').innerHTML = 
                        `<div class="error-message">加载失败: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('加载订单列表错误:', error);
                document.getElementById('ordersList').innerHTML = 
                    '<div class="error-message">网络错误，无法加载订单列表</div>';
            }
        }

        // 显示订单列表（分页版本）
        function displayOrdersList() {
            const listDiv = document.getElementById('ordersList');
            const countBadge = document.getElementById('ordersCount');
            const paginationNav = document.getElementById('paginationNav');
            
            if (allOrders.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-muted">暂无订单数据</div>';
                countBadge.textContent = '0 条订单';
                paginationNav.style.display = 'none';
                return;
            }

            // 更新订单总数显示
            countBadge.textContent = `${allOrders.length} 条订单`;

            // 计算分页
            const totalPages = Math.ceil(allOrders.length / ordersPerPage);
            const startIndex = (currentPage - 1) * ordersPerPage;
            const endIndex = startIndex + ordersPerPage;
            const currentOrders = allOrders.slice(startIndex, endIndex);

            // 显示当前页的订单
            let html = `<div class="row">`;
            currentOrders.forEach(order => {
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card order-card h-100 position-relative" 
                             onclick="selectOrder('${order.order_id}')">
                            <!-- 打印选择复选框 -->
                            <div class="form-check position-absolute" style="top: 10px; right: 10px; z-index: 10;">
                                <input class="form-check-input print-checkbox" type="checkbox" 
                                       value="${order.order_id}" id="print_${order.order_id}"
                                       onclick="event.stopPropagation();">
                                <label class="form-check-label visually-hidden" for="print_${order.order_id}">
                                    选择打印
                                </label>
                            </div>
                            
                            <div class="card-body" style="cursor: pointer;">
                                <div class="order-id mb-2">${order.order_id}</div>
                                <p class="mb-1"><strong>${order.customer_name}</strong></p>
                                <p class="mb-1 text-muted small">${order.order_date}</p>
                                <p class="amount mb-2">¥${parseFloat(order.amount).toFixed(2)}</p>
                                <p class="text-muted small" style="height: 3em; overflow: hidden;">
                                    ${order.product_details}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
            
            listDiv.innerHTML = html;

            // 显示分页导航
            if (totalPages > 1) {
                displayPagination(totalPages);
                paginationNav.style.display = 'block';
            } else {
                paginationNav.style.display = 'none';
            }
        }

        // 显示分页导航
        function displayPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let html = '';

            // 上一页按钮
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(${currentPage - 1})">
                        <i class="bi bi-chevron-left"></i> 上一页
                    </a>
                </li>
            `;

            // 页码按钮
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // 调整开始页码
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // 第一页
            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="goToPage(1)">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // 中间页码
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                    </li>
                `;
            }

            // 最后一页
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="goToPage(${totalPages})">${totalPages}</a></li>`;
            }

            // 下一页按钮
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(${currentPage + 1})">
                        下一页 <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;

            pagination.innerHTML = html;
        }

        // 跳转到指定页码
        function goToPage(page) {
            const totalPages = Math.ceil(allOrders.length / ordersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayOrdersList();
            
            // 滚动到订单列表顶部
            document.querySelector('.card-header h5').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // 选择订单
        function selectOrder(orderId) {
            document.getElementById('searchOrderId').value = orderId;
            searchOrder();
            
            // 滚动到订单详情
            document.getElementById('orderResult').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // 显示错误信息
        function showError(message) {
            const resultDiv = document.getElementById('orderResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="error-message">
                            <i class="bi bi-exclamation-triangle"></i> ${message}
                        </div>
                    </div>
                </div>
            `;
        }

        // 上传Excel文件
        async function uploadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showUploadError('请选择要上传的文件');
                return;
            }

            // 检查文件类型
            const allowedTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
                showUploadError('文件格式不支持，请上传.xlsx或.xls格式的Excel文件');
                return;
            }

            // 检查文件大小（16MB）
            if (file.size > 16 * 1024 * 1024) {
                showUploadError('文件大小超过16MB限制');
                return;
            }

            // 显示上传进度
            showUploadProgress();

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                hideUploadProgress();

                if (data.success) {
                    showUploadSuccess(data.message, data.orders_count, data.qr_count);
                    // 刷新订单列表
                    loadAllOrders();
                    // 清空文件选择
                    fileInput.value = '';
                } else {
                    // 检查是否有重复订单号信息
                    const duplicates = data.duplicates || null;
                    showUploadError(data.error || '上传处理失败', duplicates);
                }
            } catch (error) {
                console.error('上传错误:', error);
                hideUploadProgress();
                showUploadError('网络错误，请检查连接');
            }
        }

        // 显示上传进度
        function showUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadResult').innerHTML = '';
        }

        // 隐藏上传进度
        function hideUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('uploadBtn').disabled = false;
        }

        // 显示上传成功消息
        function showUploadSuccess(message, ordersCount, qrCount) {
            document.getElementById('uploadResult').innerHTML = `
                <div class="success-message">
                    <i class="bi bi-check-circle"></i> 
                    <strong>上传成功！</strong><br>
                    ${message}<br>
                    <small>处理了 ${ordersCount} 条订单，生成了 ${qrCount} 个二维码</small>
                </div>
            `;
        }

        // 显示上传错误消息
        function showUploadError(message, duplicates = null) {
            let errorHtml = `
                <div class="error-message">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>上传失败：</strong> ${message}
            `;
            
            // 如果有重复订单号，显示详细列表
            if (duplicates && Array.isArray(duplicates) && duplicates.length > 0) {
                errorHtml += `
                    <div class="mt-2">
                        <strong>重复的订单号：</strong>
                        <ul class="mb-0 mt-1">
                `;
                duplicates.forEach(orderId => {
                    errorHtml += `<li><code>${orderId}</code></li>`;
                });
                errorHtml += `
                        </ul>
                                                <div class="mt-2">
                            <small class="text-muted d-block mb-2">
                                <i class="bi bi-info-circle"></i> 
                                请检查Excel文件，确保订单号唯一，或点击下方按钮删除数据库中的重复订单
                            </small>
                            <button class="btn btn-warning btn-sm" onclick="deleteDuplicateOrders(${JSON.stringify(duplicates)})">
                                <i class="bi bi-trash"></i> 删除数据库中的重复订单
                            </button>
                        </div>
                    </div>
                `;
            }
            
            errorHtml += `</div>`;
            document.getElementById('uploadResult').innerHTML = errorHtml;
        }

        // Excel导出打印功能
        async function exportToExcel() {
            try {
                // 显示加载状态
                const exportBtn = document.querySelector('[onclick="exportToExcel()"]');
                const originalText = exportBtn.innerHTML;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 生成中...';
                
                const response = await fetch('/export/qrcodes');
                
                if (response.ok) {
                    // 创建下载链接
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `订单二维码打印表_${new Date().toISOString().slice(0,19).replace(/[:-]/g, '')}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // 显示成功提示
                    showTemporaryMessage('✅ Excel文件已生成，请打开文件进行打印', 'success');
                } else {
                    const error = await response.json();
                    showTemporaryMessage(`❌ 导出失败: ${error.error}`, 'error');
                }
                
                // 恢复按钮状态
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
                
            } catch (error) {
                console.error('Excel导出错误:', error);
                showTemporaryMessage('❌ 导出过程中发生错误', 'error');
                
                // 恢复按钮状态
                const exportBtn = document.querySelector('[onclick="exportToExcel()"]');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i class="bi bi-file-earmark-excel"></i> Excel打印';
            }
        }

        // 打开网页打印预览
        function openPrintPreview() {
            // 获取选中的订单
            const checkboxes = document.querySelectorAll('.print-checkbox:checked');
            let selectedOrders = Array.from(checkboxes).map(cb => cb.value);
            
            // 如果没有选中任何订单，询问是否打印全部
            if (selectedOrders.length === 0) {
                if (confirm('没有选择订单，是否打印所有订单？')) {
                    selectedOrders = allOrders.map(order => order.order_id);
                } else {
                    showTemporaryMessage('请先选择要打印的订单（点击订单卡片右上角的复选框）', 'info');
                    return;
                }
            }
            
            // 构建查询参数
            const params = new URLSearchParams();
            selectedOrders.forEach(orderId => params.append('order_id', orderId));
            
            // 打开打印预览窗口
            const printWindow = window.open(`/print?${params.toString()}`, 'printPreview', 
                'width=800,height=600,scrollbars=yes,resizable=yes');
            
            if (!printWindow) {
                showTemporaryMessage('无法打开打印预览窗口，请检查浏览器弹窗设置', 'error');
            }
        }

        // 显示临时消息
        function showTemporaryMessage(message, type = 'info') {
            // 创建消息元素
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // 添加到页面
            document.body.appendChild(alertDiv);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // 全选/取消全选打印复选框
        function toggleAllPrintCheckboxes() {
            const checkboxes = document.querySelectorAll('.print-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
        }

        // 删除重复订单
        async function deleteDuplicateOrders(orderIds) {
            if (!confirm(`确定要删除这 ${orderIds.length} 个重复订单吗？\n订单号: ${orderIds.join(', ')}`)) {
                return;
            }

            try {
                const response = await fetch('/api/duplicates', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_ids: orderIds
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // 显示成功消息
                    document.getElementById('uploadResult').innerHTML = `
                        <div class="success-message">
                            <i class="bi bi-check-circle"></i> 
                            <strong>删除成功！</strong> ${data.message}
                            <br>
                            <small>现在可以重新上传Excel文件了</small>
                        </div>
                    `;
                    
                    // 刷新订单列表
                    loadAllOrders();
                } else {
                    showUploadError(data.error || '删除重复订单失败');
                }
            } catch (error) {
                console.error('删除重复订单错误:', error);
                showUploadError('网络错误，无法删除重复订单');
            }
        }

        // 分享订单
        function shareOrder(orderId) {
            // 获取当前订单的URL
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('order_id', orderId);
            const shareUrl = currentUrl.toString();
            
            // 检查是否支持Web Share API（主要在移动端）
            if (navigator.share) {
                navigator.share({
                    title: `订单 ${orderId} 详情`,
                    text: `查看订单 ${orderId} 的详细信息`,
                    url: shareUrl
                }).then(() => {
                    showTemporaryMessage('✅ 分享成功！', 'success');
                }).catch((error) => {
                    console.log('分享失败:', error);
                    // 如果分享失败，回退到复制链接
                    copyToClipboard(shareUrl, orderId);
                });
            } else {
                // 不支持Web Share API时，复制链接到剪贴板
                copyToClipboard(shareUrl, orderId);
            }
        }

        // 复制链接到剪贴板
        function copyToClipboard(text, orderId) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showTemporaryMessage(`✅ 订单 ${orderId} 的链接已复制到剪贴板！`, 'success');
                }).catch((error) => {
                    console.error('复制失败:', error);
                    fallbackCopyToClipboard(text, orderId);
                });
            } else {
                fallbackCopyToClipboard(text, orderId);
            }
        }

        // 回退的复制方法
        function fallbackCopyToClipboard(text, orderId) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showTemporaryMessage(`✅ 订单 ${orderId} 的链接已复制！`, 'success');
                } else {
                    showManualCopyDialog(text, orderId);
                }
            } catch (err) {
                console.error('复制失败:', err);
                showManualCopyDialog(text, orderId);
            }
            
            document.body.removeChild(textArea);
        }

        // 显示手动复制对话框
        function showManualCopyDialog(text, orderId) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-share"></i> 分享订单 ${orderId}
                            </h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <p class="mb-2">请复制以下链接分享给他人：</p>
                            <div class="input-group">
                                <input type="text" class="form-control" value="${text}" id="shareUrlInput" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="selectShareUrl()">
                                    <i class="bi bi-clipboard"></i> 选择
                                </button>
                            </div>
                            <div class="mt-3 text-muted small">
                                <i class="bi bi-info-circle"></i> 
                                其他人打开此链接即可查看订单详情
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 自动选中文本
            setTimeout(() => {
                const input = document.getElementById('shareUrlInput');
                if (input) {
                    input.select();
                    input.focus();
                }
            }, 100);
        }

        // 选中分享URL
        function selectShareUrl() {
            const input = document.getElementById('shareUrlInput');
            if (input) {
                input.select();
                input.focus();
                showTemporaryMessage('📋 链接已选中，可按 Ctrl+C 复制', 'info');
            }
        }

        // ========== 仓储成本管理功能 ==========

        // 上传采购订单文件
        async function uploadPurchaseFile() {
            const fileInput = document.getElementById('purchaseFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showPurchaseError('请选择要上传的采购订单文件');
                return;
            }

            // 显示上传进度
            showPurchaseProgress();

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload_purchase', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                hidePurchaseProgress();

                if (data.success) {
                    showPurchaseSuccess(data.message, data.purchase_count);
                    fileInput.value = '';
                } else {
                    showPurchaseError(data.error);
                }
            } catch (error) {
                console.error('采购订单上传错误:', error);
                hidePurchaseProgress();
                showPurchaseError('网络错误，请检查连接');
            }
        }

        // 上传BOM文件
        async function uploadBomFile() {
            const fileInput = document.getElementById('bomFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showBomError('请选择要上传的BOM文件');
                return;
            }

            // 显示上传进度
            showBomProgress();

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload_bom', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                hideBomProgress();

                if (data.success) {
                    showBomSuccess(data.message, data.bom_count);
                    fileInput.value = '';
                } else {
                    showBomError(data.error);
                }
            } catch (error) {
                console.error('BOM上传错误:', error);
                hideBomProgress();
                showBomError('网络错误，请检查连接');
            }
        }

        // 显示采购上传进度
        function showPurchaseProgress() {
            const resultDiv = document.getElementById('purchaseUploadResult');
            resultDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                    <span>正在处理采购订单文件...</span>
                </div>
            `;
        }

        function hidePurchaseProgress() {
            // 进度隐藏由结果显示取代
        }

        function showPurchaseSuccess(message, count) {
            document.getElementById('purchaseUploadResult').innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> 
                    <strong>采购订单导入成功！</strong><br>
                    ${message}
                </div>
            `;
        }

        function showPurchaseError(message) {
            document.getElementById('purchaseUploadResult').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>采购订单导入失败：</strong> ${message}
                </div>
            `;
        }

        // 显示BOM上传进度和结果
        function showBomProgress() {
            const resultDiv = document.getElementById('bomUploadResult');
            resultDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                    <span>正在处理BOM文件...</span>
                </div>
            `;
        }

        function hideBomProgress() {
            // 进度隐藏由结果显示取代
        }

        function showBomSuccess(message, count) {
            document.getElementById('bomUploadResult').innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> 
                    <strong>BOM导入成功！</strong><br>
                    ${message}
                </div>
            `;
        }

        function showBomError(message) {
            document.getElementById('bomUploadResult').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>BOM导入失败：</strong> ${message}
                </div>
            `;
        }

        // 加载库存汇总信息
        async function loadInventorySummary() {
            try {
                const response = await fetch('/api/inventory_summary');
                const data = await response.json();
                
                if (data.success) {
                    // 更新统计数字
                    document.getElementById('totalItems').textContent = data.total_items || '-';
                    document.getElementById('totalStock').textContent = data.total_stock || '-';
                    document.getElementById('totalValue').textContent = 
                        data.total_value ? `¥${data.total_value.toFixed(2)}` : '-';
                    
                    // 显示分类统计
                    if (data.items) {
                        displayCategoryStats(data.items);
                        displayLowStockItems(data.items);
                    }
                } else {
                    showAlert('danger', data.error || '加载库存数据失败');
                }
            } catch (error) {
                console.error('加载库存汇总失败:', error);
                showAlert('danger', '加载库存汇总失败');
            }
        }

        // 显示分类库存统计
        function displayCategoryStats(data) {
            const container = document.getElementById('categoryStats');
            if (!container) return;

            // 按类别分组
            const categories = {
                '原材料': {
                    icon: 'bi-box-seam',
                    color: 'primary',
                    items: []
                },
                '包装': {
                    icon: 'bi-box2',
                    color: 'success',
                    items: []
                },
                '配件': {
                    icon: 'bi-tools',
                    color: 'info',
                    items: []
                },
                '产品': {
                    icon: 'bi-box2-heart',
                    color: 'warning',
                    items: []
                }
            };
            
            // 分类数据
            data.forEach(item => {
                if (categories[item.item_category]) {
                    categories[item.item_category].items.push(item);
                }
            });
            
            // 生成HTML
            let html = '';
            Object.entries(categories).forEach(([category, info]) => {
                const items = info.items;
                if (items.length === 0) return;
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center cursor-pointer"
                             onclick="toggleCategoryItems('${category}')">
                            <h6 class="mb-0">
                                <i class="bi ${info.icon} text-${info.color}"></i> 
                                ${category}
                                <span class="badge bg-${info.color} ms-2">${items.length}个</span>
                            </h6>
                            <div>
                                <small class="text-muted me-3">
                                    总值: ¥${items.reduce((sum, item) => sum + item.total_value, 0).toFixed(2)}
                                </small>
                                <i class="bi bi-chevron-down category-toggle" id="toggle-${category}"></i>
                            </div>
                        </div>
                        <div class="collapse" id="category-${category}">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>编码</th>
                                                <th>名称</th>
                                                <th class="text-end">库存</th>
                                                <th class="text-end">单价</th>
                                                <th class="text-end">总值</th>
                                                <th class="text-center">阈值设置</th>
                                                <th class="text-center">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.map(item => `
                                                <tr>
                                                    <td><small>${item.item_code}</small></td>
                                                    <td>${item.item_name}</td>
                                                    <td class="text-end">
                                                        ${item.current_stock}
                                                        <small class="text-muted">${item.unit}</small>
                                                        ${item.current_stock <= item.low_stock_threshold ? 
                                                            '<span class="badge bg-danger ms-1">库存不足</span>' : 
                                                            (item.current_stock <= item.warning_stock_threshold ? 
                                                                '<span class="badge bg-warning ms-1">库存偏低</span>' : '')}
                                                    </td>
                                                    <td class="text-end">¥${item.weighted_avg_price.toFixed(2)}</td>
                                                    <td class="text-end">¥${item.total_value.toFixed(2)}</td>
                                                    <td class="text-center">
                                                        <button class="btn btn-outline-primary btn-sm"
                                                                onclick="showThresholdModal('${item.item_code}', ${item.low_stock_threshold}, ${item.warning_stock_threshold})">
                                                            <i class="bi bi-sliders"></i> 设置阈值
                                                        </button>
                                                    </td>
                                                    <td class="text-center">
                                                        <button class="btn btn-outline-secondary btn-sm"
                                                                onclick="editInventoryItem('${item.item_code}', '${item.item_name}', '${item.unit}', '${item.item_category}')">
                                                            <i class="bi bi-pencil"></i> 编辑
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="alert alert-info">暂无库存数据</div>';
        }

        // 展开/收缩分类
        function toggleCategoryItems(category) {
            const collapse = document.getElementById(`category-${category}`);
            const toggle = document.getElementById(`toggle-${category}`);
            
            if (collapse.classList.contains('show')) {
                collapse.classList.remove('show');
                toggle.classList.remove('bi-chevron-up');
                toggle.classList.add('bi-chevron-down');
            } else {
                collapse.classList.add('show');
                toggle.classList.remove('bi-chevron-down');
                toggle.classList.add('bi-chevron-up');
            }
        }

        // 显示阈值设置模态框
        function showThresholdModal(itemCode, lowThreshold, warningThreshold) {
            document.getElementById('thresholdItemCode').value = itemCode;
            document.getElementById('lowStockThreshold').value = lowThreshold;
            document.getElementById('warningStockThreshold').value = warningThreshold;
            
            const modal = new bootstrap.Modal(document.getElementById('thresholdModal'));
            modal.show();
        }

        // 保存阈值设置
        async function saveThresholds() {
            const itemCode = document.getElementById('thresholdItemCode').value;
            const lowThreshold = parseInt(document.getElementById('lowStockThreshold').value);
            const warningThreshold = parseInt(document.getElementById('warningStockThreshold').value);
            
            if (warningThreshold < lowThreshold) {
                showAlert('danger', '警告阈值必须大于低库存阈值');
                return;
            }
            
            try {
                const response = await fetch('/api/update_thresholds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_code: itemCode,
                        low_stock_threshold: lowThreshold,
                        warning_stock_threshold: warningThreshold
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('success', '阈值设置已更新');
                    bootstrap.Modal.getInstance(document.getElementById('thresholdModal')).hide();
                    loadInventorySummary(); // 刷新显示
                } else {
                    showAlert('danger', result.error || '更新失败');
                }
            } catch (error) {
                console.error('保存阈值设置失败:', error);
                showAlert('danger', '网络错误，保存失败');
            }
        }

        // 显示物料编辑模态框
        function editInventoryItem(itemCode, itemName, unit, category) {
            document.getElementById('editItemCode').value = itemCode;
            document.getElementById('editItemName').value = itemName;
            document.getElementById('editItemUnit').value = unit;
            document.getElementById('editItemCategory').value = category;
            
            const modal = new bootstrap.Modal(document.getElementById('inventoryItemModal'));
            modal.show();
        }

        // 保存物料信息
        async function saveInventoryItem() {
            const itemCode = document.getElementById('editItemCode').value;
            const itemName = document.getElementById('editItemName').value;
            const unit = document.getElementById('editItemUnit').value;
            const category = document.getElementById('editItemCategory').value;
            
            try {
                const response = await fetch('/api/update_inventory_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_code: itemCode,
                        item_name: itemName,
                        unit: unit,
                        item_category: category
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('success', '物料信息已更新');
                    bootstrap.Modal.getInstance(document.getElementById('inventoryItemModal')).hide();
                    loadInventorySummary(); // 刷新显示
                } else {
                    showAlert('danger', result.error || '更新失败');
                }
            } catch (error) {
                console.error('保存物料信息失败:', error);
                showAlert('danger', '网络错误，保存失败');
            }
        }

        // 显示库存不足提醒
        function displayLowStockItems(data) {
            const container = document.getElementById('lowStockItems');
            if (!container) return;
            
            // 筛选库存不足的物料
            const lowStockItems = data.filter(item => 
                item.current_stock <= item.low_stock_threshold
            );
            
            if (lowStockItems.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle"></i> 当前没有库存不足的物料
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="list-group list-group-flush">
                    ${lowStockItems.map(item => `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${item.item_name}</h6>
                                    <small class="text-muted">${item.item_code}</small>
                                </div>
                                <span class="badge bg-${item.current_stock <= item.low_stock_threshold ? 'danger' : 'warning'}">
                                    ${item.current_stock} / ${item.warning_stock_threshold}
                                </span>
                            </div>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-${item.current_stock <= item.low_stock_threshold ? 'danger' : 'warning'}"
                                     role="progressbar"
                                     style="width: ${(item.current_stock / item.warning_stock_threshold * 100).toFixed(0)}%">
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载库存汇总
            loadInventorySummary();
            
            // 设置定时刷新（每5分钟）
            setInterval(loadInventorySummary, 5 * 60 * 1000);
        });

        // 加载成本分析
        async function loadCostAnalysis() {
            console.log('开始加载成本分析...');
            
            try {
                const response = await fetch('/api/cost_analysis', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log('成本分析API响应状态:', response.status);
                
                if (response.status === 401) {
                    throw new Error('认证失败，请重新登录');
                }
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('成本分析API返回数据:', data);

                if (data.success) {
                    displayCostAnalysis(data);
                    if (data.cost_configs) {
                        displayCostConfigs(data.cost_configs);
                    }
                } else {
                    console.error('成本分析加载失败:', data.error);
                    // 显示错误信息到页面
                    const recentDiv = document.getElementById('recentCalculations');
                    if (recentDiv) {
                        recentDiv.innerHTML = `<div class="alert alert-warning">加载成本分析失败: ${data.error}</div>`;
                    }
                }
            } catch (error) {
                console.error('成本分析请求错误:', error);
                const recentDiv = document.getElementById('recentCalculations');
                if (recentDiv) {
                    recentDiv.innerHTML = `<div class="alert alert-danger">网络错误: ${error.message}</div>`;
                }
            }
        }

        // 显示成本分析
        function displayCostAnalysis(data) {
            const container = document.getElementById('costAnalysisContainer');
            if (!container || !data || !data.cost_details) return;

            // 创建饼图容器
            const chartContainer = document.createElement('div');
            chartContainer.style.height = '300px';
            chartContainer.style.marginBottom = '1rem';
            container.appendChild(chartContainer);

            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);

            // 准备图表数据
            const chartData = data.cost_details.map(item => ({
                name: item.name,
                value: item.value,
                percentage: item.percentage
            }));

            // 按百分比降序排序
            chartData.sort((a, b) => b.percentage - a.percentage);

            // 创建饼图
            new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: chartData.map(item => `${item.name} (${item.percentage.toFixed(2)}%)`),
                    datasets: [{
                        data: chartData.map(item => item.value),
                        backgroundColor: [
                            '#FF6384',  // 红色
                            '#36A2EB',  // 蓝色
                            '#FFCE56',  // 黄色
                            '#4BC0C0',  // 青色
                            '#9966FF',  // 紫色
                            '#FF9F40',  // 橙色
                            '#FF99CC',  // 粉色
                            '#99FF99',  // 浅绿色
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const backgroundColor = data.datasets[0].backgroundColor[i];
                                            return {
                                                text: `${label} (¥${value.toFixed(2)})`,
                                                fillStyle: backgroundColor,
                                                strokeStyle: backgroundColor,
                                                lineWidth: 1,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = chartData[context.dataIndex].percentage;
                                    return `${context.label}: ¥${value.toFixed(2)} (${percentage.toFixed(2)}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 添加成本明细表格
            let html = `
                <div class="table-responsive mt-3">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>成本项目</th>
                                <th>类型</th>
                                <th class="text-end">金额</th>
                                <th class="text-end">占比</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            chartData.forEach(item => {
                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.type === 'percentage' ? '百分比' : '固定值'}</td>
                        <td class="text-end">¥${item.value.toFixed(2)}</td>
                        <td class="text-end">${item.percentage.toFixed(2)}%</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="2">总成本</th>
                                <th class="text-end">¥${data.total_cost.toFixed(2)}</th>
                                <th class="text-end">100%</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            container.innerHTML += html;
        }

        function displayCostConfigs(configs) {
            console.log('显示成本配置:', configs);
            
            // 这里可以显示成本配置，比如人工费率、管理费率等
            const container = document.getElementById('costConfigContainer');
            if (!container) {
                console.log('找不到成本配置容器');
                return;
            }
            
            if (!configs || configs.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        暂无成本配置数据
                    </div>
                `;
                return;
            }
            
            let html = '<div class="row">';
            configs.forEach(config => {
                // 根据配置类型显示中文名称
                const configNames = {
                    'labor_cost_rate': '人工费率',
                    'management_cost_rate': '管理费率',
                    'transport_cost_rate': '运输费率',
                    'overhead_cost_rate': '间接费率'
                };
                
                const displayName = configNames[config.config_type] || config.description || config.config_type;
                const unit = config.config_type.includes('rate') ? '%' : '元';
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-body">
                                <h6>${displayName}</h6>
                                <div class="input-group">
                                    <input type="number" class="form-control" 
                                           value="${config.config_value}" 
                                           id="config_${config.config_type}"
                                           step="0.01" min="0">
                                    <span class="input-group-text">${unit}</span>
                                    <button class="btn btn-outline-primary" type="button"
                                            onclick="updateCostConfig('${config.config_type}')">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </div>
                                <small class="text-muted">${config.description || ''}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        async function updateCostConfig(configType) {
            const input = document.getElementById(`config_${configType}`);
            if (!input) return;
            
            const value = parseFloat(input.value);
            if (isNaN(value) || value < 0) {
                showAlert('danger', '请输入有效的数值');
                return;
            }
            
            try {
                const response = await fetch('/api/update_cost_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        config_type: configType,
                        config_value: value
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('success', '成本配置更新成功');
                } else {
                    showAlert('danger', '更新失败: ' + result.error);
                }
            } catch (error) {
                console.error('更新成本配置错误:', error);
                showAlert('danger', '更新失败: ' + error.message);
            }
        }
        
        // 加载产品列表（有BOM的产品）
        async function loadProductList() {
            try {
                const response = await fetch('/api/products_with_bom');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('productCode');
                    select.innerHTML = '<option value="">请选择产品</option>';
                    
                    data.products.forEach(product => {
                        select.innerHTML += `
                            <option value="${product.code}">
                                ${product.code} - ${product.name}
                            </option>
                        `;
                    });
                } else {
                    showAlert('danger', '加载产品列表失败');
                }
            } catch (error) {
                console.error('加载产品列表失败:', error);
                showAlert('danger', '加载产品列表失败');
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化功能...');
            
            // 加载产品列表
            loadProductList();
            
            // 绑定产品选择事件
            const productSelect = document.getElementById('productCode');
            if (productSelect) {
                productSelect.addEventListener('change', function() {
                    const selectedProduct = this.value;
                    console.log('选择的产品:', selectedProduct);
                    if (selectedProduct) {
                        // 清空之前的计算结果
                        document.getElementById('costResult').innerHTML = '';
                        // 重置输入
                        document.getElementById('quantity').value = '1';
                        document.getElementById('laborHours').value = '0';
                    }
                });
            }
        });

        // 加载成本配置项
        async function loadCostConfigItems() {
            try {
                const response = await fetch('/api/cost_config_items');
                const data = await response.json();
                
                const container = document.getElementById('costConfigItemsContainer');
                if (!container) return;
                
                if (data.success && data.items) {
                    let html = '<div class="table-responsive"><table class="table table-hover">';
                    html += `
                        <thead>
                            <tr>
                                <th>配置项</th>
                                <th>类型</th>
                                <th>默认值</th>
                                <th>单位</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    data.items.forEach(item => {
                        const typeText = item.type === 'percentage' ? '百分比' : '固定值';
                        html += `
                            <tr>
                                <td>
                                    ${item.name}
                                    ${item.description ? `<br><small class="text-muted">${item.description}</small>` : ''}
                                </td>
                                <td>${typeText}</td>
                                <td>${item.default_value}</td>
                                <td>${item.unit}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editCostConfig(${item.id})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteCostConfig(${item.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="alert alert-info">暂无成本配置项</div>';
                }
            } catch (error) {
                console.error('加载成本配置项失败:', error);
                showAlert('danger', '加载成本配置项失败');
            }
        }

        // 显示添加成本配置项模态框
        function showAddCostConfigModal() {
            document.getElementById('costConfigId').value = '';
            document.getElementById('costConfigForm').reset();
            document.getElementById('costConfigModalTitle').textContent = '添加成本配置项';
            
            const modal = new bootstrap.Modal(document.getElementById('costConfigModal'));
            modal.show();
        }

        // 编辑成本配置项
        async function editCostConfig(id) {
            try {
                const response = await fetch(`/api/cost_config_items/${id}`);
                const data = await response.json();
                
                if (data.success && data.item) {
                    const item = data.item;
                    document.getElementById('costConfigId').value = item.id;
                    document.getElementById('configName').value = item.name;
                    document.getElementById('configType').value = item.type;
                    document.getElementById('configValue').value = item.default_value;
                    document.getElementById('configUnit').value = item.unit;
                    document.getElementById('configDescription').value = item.description || '';
                    
                    document.getElementById('costConfigModalTitle').textContent = '编辑成本配置项';
                    
                    const modal = new bootstrap.Modal(document.getElementById('costConfigModal'));
                    modal.show();
                } else {
                    showAlert('danger', '获取配置项数据失败');
                }
            } catch (error) {
                console.error('获取成本配置项失败:', error);
                showAlert('danger', '获取成本配置项失败');
            }
        }

        // 保存成本配置项
        async function saveCostConfig() {
            const form = document.getElementById('costConfigForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = document.getElementById('costConfigId').value;
            const data = {
                name: document.getElementById('configName').value,
                type: document.getElementById('configType').value,
                default_value: parseFloat(document.getElementById('configValue').value),
                unit: document.getElementById('configUnit').value,
                description: document.getElementById('configDescription').value
            };
            
            try {
                const url = id ? `/api/cost_config_items/${id}` : '/api/cost_config_items';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', id ? '成本配置项更新成功' : '成本配置项添加成功');
                    bootstrap.Modal.getInstance(document.getElementById('costConfigModal')).hide();
                    loadCostConfigItems(); // 重新加载列表
                } else {
                    showAlert('danger', result.error || '保存失败');
                }
            } catch (error) {
                console.error('保存成本配置项失败:', error);
                showAlert('danger', '保存失败: ' + error.message);
            }
        }

        // 删除成本配置项
        async function deleteCostConfig(id) {
            if (!confirm('确定要删除这个成本配置项吗？')) return;
            
            try {
                const response = await fetch(`/api/cost_config_items/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', result.message);
                    loadCostConfigItems();
                } else {
                    showAlert('danger', result.error);
                }
            } catch (error) {
                console.error('删除成本配置项失败:', error);
                showAlert('danger', '删除失败');
            }
        }

        // 计算产品成本
        async function calculateProductCost() {
            const productCode = document.getElementById('productCode').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const laborHours = parseFloat(document.getElementById('laborHours').value);

            if (!productCode) {
                showAlert('warning', '请选择产品');
                return;
            }

            // 显示计算进度
            const resultDiv = document.getElementById('costCalculationResult');
            resultDiv.innerHTML = `
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2">正在计算产品成本...</p>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/calculate_cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_code: productCode,
                        quantity: quantity,
                        labor_hours: laborHours
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayCostCalculationResult(data.cost_breakdown);
                    // 刷新成本列表
                    loadProductCosts();
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> 
                            计算失败：${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('成本计算错误:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> 
                        网络错误，无法计算成本
                    </div>
                `;
            }
        }

        // 加载已计算的产品成本列表
        async function loadProductCosts() {
            try {
                const response = await fetch('/api/product_costs');
                const data = await response.json();
                
                // 更新已计算产品成本表格
                const costsContainer = document.getElementById('productCostsContainer');
                if (costsContainer) {
                    if (!data.success || !data.costs || data.costs.length === 0) {
                        costsContainer.innerHTML = '<div class="alert alert-info">暂无成本计算记录</div>';
                        return;
                    }

                    let html = '<div class="table-responsive"><table class="table table-hover table-sm">';
                    html += `
                        <thead>
                            <tr>
                                <th>产品信息</th>
                                <th>材料成本</th>
                                <th>人工成本</th>
                                <th>管理成本</th>
                                <th>运输成本</th>
                                <th>其他成本</th>
                                <th>总成本</th>
                                <th>单位成本</th>
                                <th>计算时间</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;
                    
                    data.costs.forEach(cost => {
                        const calculationDate = new Date(cost.calculation_date).toLocaleString();
                        html += `
                            <tr>
                                <td>
                                    <div class="fw-bold">${cost.product_code}</div>
                                    <small class="text-muted">${cost.product_name}</small>
                                </td>
                                <td>¥${cost.material_cost.toFixed(2)}</td>
                                <td>¥${cost.labor_cost.toFixed(2)}</td>
                                <td>¥${cost.management_cost.toFixed(2)}</td>
                                <td>¥${cost.transport_cost.toFixed(2)}</td>
                                <td>¥${cost.other_cost.toFixed(2)}</td>
                                <td class="fw-bold">¥${cost.total_cost.toFixed(2)}</td>
                                <td class="fw-bold text-primary">¥${cost.unit_cost.toFixed(2)}</td>
                                <td><small>${calculationDate}</small></td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    costsContainer.innerHTML = html;
                }

                // 更新成本分析下拉框和显示
                const analysisSelect = document.querySelector('.cost-analysis-select');
                const analysisContainer = document.getElementById('costAnalysisContainer');
                
                if (analysisSelect && analysisContainer) {
                    if (!data.success || !data.costs || data.costs.length === 0) {
                        analysisSelect.innerHTML = '<option value="">暂无产品数据</option>';
                        analysisContainer.innerHTML = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                暂无成本分析数据，请先计算产品成本
                            </div>
                        `;
                        return;
                    }

                    // 更新下拉框
                    analysisSelect.innerHTML = '<option value="">请选择产品...</option>';
                    data.costs.forEach(cost => {
                        const option = document.createElement('option');
                        option.value = cost.product_code;
                        option.textContent = `${cost.product_name || cost.product_code}`;
                        analysisSelect.appendChild(option);
                    });

                    // 绑定选择事件
                    analysisSelect.onchange = function() {
                        if (this.value) {
                            const selectedCost = data.costs.find(cost => cost.product_code === this.value);
                            if (selectedCost) {
                                showCostAnalysis(selectedCost);
                            }
                } else {
                            analysisContainer.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> 
                                    请选择要查看的产品
                                </div>
                            `;
                        }
                    };

                    // 显示提示信息
                    analysisContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            请选择要查看的产品
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('加载成本记录失败:', error);
                const container = document.getElementById('productCostsContainer');
                if (container) {
                    container.innerHTML = '<div class="alert alert-danger">加载成本记录失败</div>';
                }
            }
        }

        // 显示成本分析
        function showCostAnalysis(cost) {
            const container = document.getElementById('costAnalysisContainer');
            if (!container || !cost) return;

            // 准备成本数据
            const costItems = [
                { name: '材料成本', value: cost.material_cost },
                { name: '人工成本', value: cost.labor_cost },
                { name: '管理成本', value: cost.management_cost },
                { name: '运输成本', value: cost.transport_cost },
                { name: '其他成本', value: cost.other_cost }
            ].filter(item => item.value > 0);

            // 计算百分比
            costItems.forEach(item => {
                item.percentage = (item.value / cost.total_cost * 100).toFixed(2);
            });

            // 创建成本分析卡片
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-7">
                        <div class="cost-chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="table-responsive">
                            <table class="table table-sm cost-summary">
                                <tbody>
                                    ${costItems.map(item => `
                                        <tr>
                                            <td>
                                                <i class="bi ${getCostIcon(item.name)}"></i>
                                                <span class="${getCostClass(item.name)}">${item.name}</span>
                                            </td>
                                            <td class="text-end">
                                                <div class="fw-bold ${getCostClass(item.name)}">
                                                    ¥${item.value.toFixed(2)}
                                                </div>
                                                <div class="cost-percentage">${item.percentage}%</div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    <tr class="table-secondary">
                                        <td>
                                            <i class="bi bi-calculator"></i>
                                            总成本
                                        </td>
                                        <td class="text-end fw-bold">¥${cost.total_cost.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // 创建饼图
            const ctx = document.getElementById('costChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: costItems.map(item => item.name),
                        datasets: [{
                            data: costItems.map(item => item.value),
                            backgroundColor: costItems.map(item => getCostColor(item.name)),
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 12
                                    },
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const percentage = (value / cost.total_cost * 100).toFixed(2);
                                        return `${context.label}: ¥${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // 显示成本计算结果
        function displayCostCalculationResult(cost) {
            const container = document.getElementById('costResultContainer');
            if (!container || !cost) return;

            // 先显示总成本和单位成本
            const summaryContainer = document.getElementById('costSummary');
            if (summaryContainer) {
                let summaryHtml = `
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5 class="mb-0">¥${cost.total_cost.toFixed(2)}</h5>
                                        <small class="text-muted">总成本</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h5 class="mb-0">¥${cost.unit_cost.toFixed(2)}</h5>
                                        <small class="text-muted">单位成本</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                summaryContainer.innerHTML = summaryHtml;
            }

            // 显示成本明细
            const detailsContainer = document.getElementById('costDetails');
            if (detailsContainer) {
                let detailsHtml = '';
                
                // 显示材料成本
                const materialCost = cost.cost_details.find(item => item.name === '材料成本');
                if (materialCost) {
                    detailsHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-box text-primary"></i> 材料成本
                                <small class="text-muted d-block">BOM清单汇总</small>
                            </div>
                            <div class="text-end">
                                <div>¥${materialCost.value.toFixed(2)}</div>
                                <small class="text-muted">${materialCost.percentage.toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                }

                // 显示人工成本
                const laborCost = cost.cost_details.find(item => item.name === '人工成本');
                if (laborCost) {
                    const calculationMethod = laborCost.type === 'fixed' ? 
                        `${cost.labor_hours}小时 × ${(laborCost.value / cost.labor_hours).toFixed(2)}元/小时` :
                        '材料成本的百分比';
                    detailsHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-person text-success"></i> 人工成本
                                <small class="text-muted d-block">${calculationMethod}</small>
                            </div>
                            <div class="text-end">
                                <div>¥${laborCost.value.toFixed(2)}</div>
                                <small class="text-muted">${laborCost.percentage.toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                }

                // 显示管理成本
                const managementCost = cost.cost_details.find(item => item.name === '管理成本');
                if (managementCost) {
                    const calculationMethod = managementCost.type === 'fixed' ? 
                        '固定金额' : '材料成本的百分比';
                    detailsHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-building text-info"></i> 管理成本
                                <small class="text-muted d-block">${calculationMethod}</small>
                            </div>
                            <div class="text-end">
                                <div>¥${managementCost.value.toFixed(2)}</div>
                                <small class="text-muted">${managementCost.percentage.toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                }

                // 显示运输成本
                const transportCost = cost.cost_details.find(item => item.name === '运输成本');
                if (transportCost) {
                    const calculationMethod = transportCost.type === 'fixed' ? 
                        '固定金额' : '材料成本的百分比';
                    detailsHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-truck text-warning"></i> 运输成本
                                <small class="text-muted d-block">${calculationMethod}</small>
                            </div>
                            <div class="text-end">
                                <div>¥${transportCost.value.toFixed(2)}</div>
                                <small class="text-muted">${transportCost.percentage.toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                }

                // 显示其他费用
                const otherCosts = cost.cost_details.filter(item => 
                    !['材料成本', '人工成本', '管理成本', '运输成本'].includes(item.name) && !item.is_tax);
                otherCosts.forEach(item => {
                    const calculationMethod = item.type === 'fixed' ? 
                        '固定金额' : '材料成本的百分比';
                    detailsHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-three-dots text-secondary"></i> ${item.name}
                                <small class="text-muted d-block">${calculationMethod}</small>
                            </div>
                            <div class="text-end">
                                <div>¥${item.value.toFixed(2)}</div>
                                <small class="text-muted">${item.percentage.toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                });

                // 显示不含税小计
                detailsHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-2 py-2 border-top">
                        <div>
                            <strong>不含税小计</strong>
                        </div>
                        <div class="text-end">
                            <strong>¥${cost.subtotal_cost.toFixed(2)}</strong>
                        </div>
                    </div>
                `;

                // 显示税费
                const taxCost = cost.cost_details.find(item => item.is_tax);
                if (taxCost) {
                    const calculationMethod = taxCost.type === 'fixed' ? 
                        '固定金额' : '不含税小计的百分比';
                    detailsHtml += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-receipt text-danger"></i> ${taxCost.name}
                                <small class="text-muted d-block">${calculationMethod}</small>
                            </div>
                            <div class="text-end">
                                <div>¥${taxCost.value.toFixed(2)}</div>
                                <small class="text-muted">${taxCost.percentage.toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                }

                // 显示总成本
                detailsHtml += `
                    <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                        <div>
                            <strong>总成本</strong>
                            <small class="text-muted d-block">含税总金额</small>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-0">¥${cost.total_cost.toFixed(2)}</h5>
                            <small class="text-muted">单位成本: ¥${cost.unit_cost.toFixed(2)}</small>
                        </div>
                    </div>
                `;

                detailsContainer.innerHTML = detailsHtml;
            }

            // 显示计算说明
            const noteContainer = document.getElementById('costNote');
            if (noteContainer) {
                let noteHtml = `
                    <div class="alert alert-info mt-3 mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i> 
                            成本计算说明：<br>
                            1. 材料成本：根据BOM清单和当前库存价格计算<br>
                            2. 人工成本：${cost.labor_hours}小时 × 人工费率<br>
                            3. 百分比类型费用：基于材料成本计算<br>
                            4. 固定值类型费用：直接计入成本<br>
                            5. 税费：基于不含税小计计算<br>
                            <br>
                            计算时间：${cost.calculation_date}
                        </small>
                    </div>
                `;
                noteContainer.innerHTML = noteHtml;
            }
        }

        // BOM管理功能
        function loadBomList() {
            console.log('开始加载BOM列表...');
            
            const container = document.getElementById('bomListContainer');
            if (!container) {
                console.error('找不到BOM容器 bomListContainer');
                return;
            }
            
            container.innerHTML = `
                <div class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    正在加载BOM数据...
                </div>
            `;
            
            fetch('/api/bom_list', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    console.log('BOM API响应状态:', response.status);
                    console.log('BOM API响应头:', response.headers);
                    
                    if (response.status === 401) {
                        throw new Error('需要登录，请刷新页面重新登录');
                    }
                    if (response.status === 404) {
                        throw new Error('BOM API接口不存在');
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('BOM API返回数据:', data);
                    if (data && data.success) {
                        displayBomList(data.bom_list || []);
                    } else {
                        throw new Error(data.error || 'BOM数据格式错误');
                    }
                })
                .catch(error => {
                    console.error('加载BOM列表失败:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> 
                            加载BOM数据失败: ${error.message}
                            <br><small>请检查网络连接或刷新页面重试</small>
                        </div>
                    `;
                });
        }
        
        function displayBomList(bomList) {
            console.log('显示BOM列表:', bomList);
            
            const container = document.getElementById('bomListContainer');
            if (!container) {
                console.error('找不到BOM容器');
                return;
            }
            
            if (!bomList || bomList.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        暂无BOM数据，请先导入BOM清单
                    </div>
                `;
                return;
            }
            
            // 按产品分组显示BOM
            const groupedBom = {};
            bomList.forEach(item => {
                if (!groupedBom[item.product_code]) {
                    groupedBom[item.product_code] = [];
                }
                groupedBom[item.product_code].push(item);
            });
            
            let html = '';
            for (const [productCode, items] of Object.entries(groupedBom)) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-box"></i> 产品: ${productCode}
                            </h6>
                            <span class="badge bg-primary">${items.length} 个组件</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>原料编码</th>
                                            <th>需求数量</th>
                                            <th>单位</th>
                                            <th>备注</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                items.forEach(item => {
                    html += `
                        <tr>
                            <td><strong>${item.material_code}</strong></td>
                            <td>${item.required_quantity}</td>
                            <td>${item.unit || '-'}</td>
                            <td>${item.notes || '-'}</td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm me-1" 
                                        onclick="editBomItem(${item.id})" title="编辑">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteBomItem(${item.id})" title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // BOM编辑相关函数
        function showAddBomModal() {
            document.getElementById('bomModalTitle').innerHTML = '<i class="bi bi-plus-circle"></i> 添加BOM项目';
            document.getElementById('bomForm').reset();
            document.getElementById('bomId').value = '';
            
            // 加载原料列表
            loadMaterialsList();
            
            const modal = new bootstrap.Modal(document.getElementById('bomModal'));
            modal.show();
        }
        
        // 加载原料列表到下拉框
        async function loadMaterialsList() {
            try {
                const response = await fetch('/api/materials');
                const data = await response.json();
                
                const select = document.getElementById('materialCode');
                select.innerHTML = '<option value="">请选择原料</option>';
                
                if (data.success && data.materials) {
                    data.materials.forEach(material => {
                        const option = document.createElement('option');
                        option.value = material.code;
                        option.textContent = `${material.code} - ${material.name} (${material.category})`;
                        option.setAttribute('data-unit', material.unit);
                        option.setAttribute('data-name', material.name);
                        option.setAttribute('data-category', material.category);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载原料列表失败:', error);
                showAlert('danger', '加载原料列表失败');
            }
        }
        
        // 原料选择变化时的处理
        function onMaterialChange() {
            const select = document.getElementById('materialCode');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                // 自动填充单位
                const unit = selectedOption.getAttribute('data-unit');
                if (unit) {
                    document.getElementById('unit').value = unit;
                }
                
                // 自动填充备注（可以使用原料名称作为默认备注）
                const materialName = selectedOption.getAttribute('data-name');
                if (materialName) {
                    const notesField = document.getElementById('notes');
                    if (!notesField.value.trim()) {  // 只在备注为空时自动填充
                        notesField.value = materialName;
                    }
                }
            }
        }
        
        function editBomItem(bomId) {
            // 从当前显示的BOM列表中找到对应项目
            fetch(`/api/bom_item/${bomId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const item = data.bom_item;
                        document.getElementById('bomModalTitle').innerHTML = '<i class="bi bi-pencil"></i> 编辑BOM项目';
                        document.getElementById('bomId').value = item.id;
                        document.getElementById('productCode').value = item.product_code;
                        document.getElementById('requiredQuantity').value = item.required_quantity;
                        document.getElementById('unit').value = item.unit || '';
                        document.getElementById('notes').value = item.notes || '';
                        
                        // 先加载原料列表，然后设置选中的原料
                        loadMaterialsList().then(() => {
                            document.getElementById('materialCode').value = item.material_code;
                        });
                        
                        const modal = new bootstrap.Modal(document.getElementById('bomModal'));
                        modal.show();
                    } else {
                        showAlert('danger', data.error || '获取BOM项目失败');
                    }
                })
                .catch(error => {
                    console.error('获取BOM项目错误:', error);
                    showAlert('danger', '网络错误，无法获取BOM项目');
                });
        }
        
        function saveBomItem() {
            const form = document.getElementById('bomForm');
            const formData = new FormData(form);
            const bomId = document.getElementById('bomId').value;
            
            // 将FormData转换为JSON对象
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // 如果是编辑模式，添加ID
            if (bomId) {
                data.id = bomId;
            }
            
            const isEdit = bomId !== '';
            const url = isEdit ? '/api/bom_item' : '/api/bom_item';
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', isEdit ? 'BOM项目更新成功' : 'BOM项目添加成功');
                        
                        // 关闭模态框
                        const modal = bootstrap.Modal.getInstance(document.getElementById('bomModal'));
                        modal.hide();
                        
                        // 重新加载BOM列表
                        loadBomList();
                    } else {
                        showAlert('danger', data.error || '保存失败');
                    }
                })
                .catch(error => {
                    console.error('保存BOM项目错误:', error);
                    showAlert('danger', '网络错误，保存失败');
                });
        }
        
        function deleteBomItem(bomId) {
            if (!confirm('确定要删除这个BOM项目吗？')) {
                return;
            }
            
            fetch('/api/bom_item', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: bomId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('success', 'BOM项目删除成功');
                        loadBomList(); // 重新加载列表
                    } else {
                        showAlert('danger', data.error || '删除失败');
                    }
                })
                .catch(error => {
                    console.error('删除BOM项目错误:', error);
                    showAlert('danger', '网络错误，删除失败');
                });
        }

        // 库存详情查看功能
        function showInventoryDetails(category) {
            const card = document.getElementById('inventoryDetailsCard');
            const title = document.getElementById('inventoryDetailsTitle');
            const container = document.getElementById('inventoryDetailsContainer');
            
            title.innerHTML = `<i class="bi bi-box-seam"></i> ${category} 详细清单`;
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border spinner-border-sm"></div>
                    <span class="ms-2">加载物料详情...</span>
                </div>
            `;
            
            card.style.display = 'block';
            card.scrollIntoView({ behavior: 'smooth' });
            
            fetch(`/api/inventory_items?category=${encodeURIComponent(category)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayInventoryItems(data.items, category);
                    } else {
                        container.innerHTML = '<div class="alert alert-warning">加载物料详情失败</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading inventory details:', error);
                    container.innerHTML = '<div class="alert alert-danger">网络错误，无法加载物料详情</div>';
                });
        }
        
        function displayInventoryItems(items, category) {
            const container = document.getElementById('inventoryDetailsContainer');
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>物料编码</th>
                                <th>物料名称</th>
                                <th>当前库存</th>
                                <th>加权均价</th>
                                <th>库存总值</th>
                                <th>阈值设置</th>
                                <th>最后更新</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            items.forEach(item => {
                const stockClass = item.current_stock < item.low_stock_threshold ? 'text-danger' : 
                                 item.current_stock < item.warning_stock_threshold ? 'text-warning' : 'text-success';
                
                const stockStatus = item.current_stock < item.low_stock_threshold ? '库存不足' : 
                                  item.current_stock < item.warning_stock_threshold ? '库存警告' : '库存充足';
                
                html += `
                    <tr>
                        <td><strong>${item.item_code}</strong></td>
                        <td>${item.item_name}</td>
                        <td>
                            <span class="${stockClass}">
                                ${item.current_stock} ${item.unit}
                                <small class="d-block">${stockStatus}</small>
                            </span>
                        </td>
                        <td>¥${(item.weighted_avg_price || 0).toFixed(2)}</td>
                        <td>¥${(item.total_value || 0).toFixed(2)}</td>
                        <td>
                            <div class="threshold-controls" style="min-width: 200px;">
                                <div class="row g-1 mb-1">
                                    <div class="col-5">
                                        <input type="number" class="form-control form-control-sm" 
                                               id="low_${item.id}" value="${item.low_stock_threshold || 100}" 
                                               min="1" step="1" placeholder="不足阈值">
                                    </div>
                                    <div class="col-5">
                                        <input type="number" class="form-control form-control-sm" 
                                               id="warning_${item.id}" value="${item.warning_stock_threshold || 200}" 
                                               min="1" step="1" placeholder="警告阈值">
                                    </div>
                                    <div class="col-2">
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="updateItemThreshold(${item.id})" title="更新阈值">
                                            <i class="bi bi-save"></i>
                                        </button>
                                    </div>
                                </div>
                                <small class="text-muted d-block">
                                    不足: ${item.low_stock_threshold || 100} | 警告: ${item.warning_stock_threshold || 200}
                                </small>
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">${item.last_updated || '-'}</small>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            if (items.length === 0) {
                html = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        该分类下暂无物料数据
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function hideInventoryDetails() {
            document.getElementById('inventoryDetailsCard').style.display = 'none';
        }
        
        // 阈值管理功能


        
        function showAlert(type, message) {
            // 创建临时消息显示
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
        
        // 更新物料阈值
        async function updateItemThreshold(itemId) {
            const lowThreshold = parseFloat(document.getElementById(`low_${itemId}`).value);
            const warningThreshold = parseFloat(document.getElementById(`warning_${itemId}`).value);
            
            if (isNaN(lowThreshold) || isNaN(warningThreshold)) {
                showAlert('danger', '请输入有效的数字');
                return;
            }
            
            if (lowThreshold >= warningThreshold) {
                showAlert('danger', '库存不足阈值必须小于库存警告阈值');
                return;
            }
            
            try {
                const response = await fetch('/api/update_item_thresholds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        low_threshold: lowThreshold,
                        warning_threshold: warningThreshold
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('success', '阈值更新成功');
                    // 重新加载当前显示的分类数据
                    const activeCategory = document.getElementById('inventoryDetailsTitle').textContent.split(' ')[0];
                    if (activeCategory) {
                        showInventoryDetails(activeCategory);
                    }
                } else {
                    showAlert('danger', result.error || '更新失败');
                }
            } catch (error) {
                console.error('更新阈值错误:', error);
                showAlert('danger', '网络错误，更新失败');
            }
        }
        
        // 阈值管理功能

        // 加载成本配置
        async function loadCostConfig() {
            console.log('开始加载成本配置...');
            
            try {
                const response = await fetch('/api/cost_analysis', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log('成本配置API响应状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('成本配置API返回数据:', data);
                
                if (data.success && data.cost_configs) {
                    displayCostConfigs(data.cost_configs);
                } else {
                    console.log('成本配置数据为空或格式不正确');
                    const container = document.getElementById('costConfigContainer');
                    if (container) {
                        container.innerHTML = `
                            <div class=\"alert alert-info\">
                                <i class=\"bi bi-info-circle\"></i> 
                                暂无成本配置数据
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('加载成本配置错误:', error);
                const container = document.getElementById('costConfigContainer');
                if (container) {
                    container.innerHTML = `
                        <div class=\"alert alert-danger\">
                            <i class=\"bi bi-exclamation-triangle\"></i> 
                            加载成本配置失败: ${error.message}
                        </div>
                    `;
                }
            }
        }
        
        // 加载销售订单盈亏报告
        async function loadOrderProfitReport() {
            const container = document.getElementById('orderProfitReport');
            if (!container) return;

            try {
                // 显示加载状态
                container.innerHTML = `
                    <div class="loading text-center">
                        <div class="spinner-border spinner-border-sm"></div>
                        <small class="text-muted ms-2">加载盈亏数据...</small>
                    </div>
                `;

                // 获取查询参数
                const startDate = document.getElementById('profitStartDate').value;
                const endDate = document.getElementById('profitEndDate').value;
                const productSelect = document.querySelector('.profit-product-select');
                const productCode = productSelect ? productSelect.value : '';

                // 构建查询参数
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (productCode) params.append('product_code', productCode);

                const response = await fetch(`/api/order_profit_report?${params.toString()}`);
                const data = await response.json();

                if (!data.success || !data.orders || data.orders.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            暂无订单盈亏数据
                        </div>
                    `;
                    return;
                }

                // 更新产品筛选下拉框
                const uniqueProducts = [...new Set(data.orders.map(order => order.product_code))];
                const productSelectHtml = `
                    <select class="form-select form-select-sm profit-product-select" onchange="loadOrderProfitReport()">
                        <option value="">全部产品</option>
                        ${uniqueProducts.map(code => `
                            <option value="${code}" ${code === productCode ? 'selected' : ''}>
                                ${code}
                            </option>
                        `).join('')}
                    </select>
                `;

                // 创建表格
                let html = `
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>订单号</th>
                                    <th>产品</th>
                                    <th>销售金额</th>
                                    <th>成本</th>
                                    <th>利润</th>
                                    <th>利润率</th>
                                    <th>时间</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                // 计算汇总数据
                let totalSales = 0;
                let totalCost = 0;
                let totalProfit = 0;

                // 添加订单数据
                data.orders.forEach(order => {
                    const profit = order.sale_price - order.total_cost;
                    const profitRate = (profit / order.sale_price * 100).toFixed(2);
                    const profitClass = profit >= 0 ? 'text-success' : 'text-danger';
                    const orderDate = new Date(order.order_date).toLocaleString();

                    totalSales += order.sale_price;
                    totalCost += order.total_cost;
                    totalProfit += profit;

                    html += `
                        <tr>
                            <td>${order.order_id}</td>
                            <td>
                                <div>${order.product_code}</div>
                                <small class="text-muted">${order.product_name || ''}</small>
                            </td>
                            <td>¥${order.sale_price.toFixed(2)}</td>
                            <td>¥${order.total_cost.toFixed(2)}</td>
                            <td class="${profitClass}">¥${profit.toFixed(2)}</td>
                            <td class="${profitClass}">${profitRate}%</td>
                            <td><small>${orderDate}</small></td>
                        </tr>
                    `;
                });

                // 添加汇总行
                const totalProfitRate = (totalProfit / totalSales * 100).toFixed(2);
                const totalProfitClass = totalProfit >= 0 ? 'text-success' : 'text-danger';

                html += `
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <td colspan="2" class="fw-bold">合计</td>
                                    <td class="fw-bold">¥${totalSales.toFixed(2)}</td>
                                    <td class="fw-bold">¥${totalCost.toFixed(2)}</td>
                                    <td class="fw-bold ${totalProfitClass}">¥${totalProfit.toFixed(2)}</td>
                                    <td class="fw-bold ${totalProfitClass}">${totalProfitRate}%</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- 添加曲线分析图 -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-graph-up"></i> 盈亏趋势分析</h6>
                        </div>
                        <div class="card-body">
                            <div style="height: 400px;">
                                <canvas id="profitTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML = html;

                // 更新产品筛选下拉框
                const productSelectContainer = document.querySelector('.profit-product-select').parentNode;
                if (productSelectContainer) {
                    productSelectContainer.innerHTML = productSelectHtml;
                }

                // 准备趋势图数据
                const chartData = prepareChartData(data.orders);
                
                // 创建趋势图
                const ctx = document.getElementById('profitTrendChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.dates,
                        datasets: [
                            {
                                label: '销售额',
                                data: chartData.sales,
                                borderColor: '#36A2EB',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                fill: true
                            },
                            {
                                label: '成本',
                                data: chartData.costs,
                                borderColor: '#FF6384',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                fill: true
                            },
                            {
                                label: '利润',
                                data: chartData.profits,
                                borderColor: '#4BC0C0',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '销售、成本和利润趋势'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ¥' + context.raw.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '日期'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '金额 (¥)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '¥' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('加载订单盈亏报告失败:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        加载订单盈亏报告失败: ${error.message}
                    </div>
                `;
            }
        }

        // 准备图表数据的辅助函数
        function prepareChartData(orders) {
            // 按日期分组数据
            const dateGroups = {};
            orders.forEach(order => {
                const date = order.order_date.split(' ')[0]; // 只取日期部分
                if (!dateGroups[date]) {
                    dateGroups[date] = {
                        sales: 0,
                        costs: 0,
                        profits: 0
                    };
                }
                dateGroups[date].sales += order.sale_price;
                dateGroups[date].costs += order.total_cost;
                dateGroups[date].profits += (order.sale_price - order.total_cost);
            });

            // 按日期排序
            const sortedDates = Object.keys(dateGroups).sort();

            return {
                dates: sortedDates,
                sales: sortedDates.map(date => dateGroups[date].sales),
                costs: sortedDates.map(date => dateGroups[date].costs),
                profits: sortedDates.map(date => dateGroups[date].profits)
            };
        }

        // 更新产品选择下拉框
        async function updateProfitProductSelect() {
            try {
                const response = await fetch('/api/product_costs');
                const data = await response.json();
                
                const select = document.querySelector('.profit-product-select');
                if (!select) return;
                
                select.innerHTML = '<option value="">全部产品</option>';
                
                if (data.success && data.costs) {
                    data.costs.forEach(cost => {
                        const option = document.createElement('option');
                        option.value = cost.product_code;
                        option.textContent = cost.product_name || cost.product_code;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('加载产品列表失败:', error);
            }
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期范围（最近30天）
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            const profitStartDate = document.getElementById('profitStartDate');
            const profitEndDate = document.getElementById('profitEndDate');
            
            if (profitStartDate) profitStartDate.value = startDate.toISOString().split('T')[0];
            if (profitEndDate) profitEndDate.value = endDate.toISOString().split('T')[0];
            
            // 加载初始数据
            loadProductCosts();
            updateProfitProductSelect();
            loadOrderProfitReport();
            
            // 加载BOM列表
            loadBomList();
        });

        // 成本分析报告
        async function loadCostAnalysisReport() {
            try {
                const container = document.getElementById('costAnalysisContainer');
                const select = document.getElementById('productSelect');
                if (!container || !select) return;

                container.innerHTML = `
                    <div class="loading text-center py-3">
                        <div class="spinner-border spinner-border-sm"></div>
                        <small class="text-muted ms-2">加载成本分析数据...</small>
                    </div>
                `;

                const response = await fetch('/api/cost_analysis_report');
                const result = await response.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            暂无成本分析数据，请先计算产品成本
                        </div>
                    `;
                    select.innerHTML = '<option value="">暂无产品数据</option>';
                    return;
                }

                // 保存数据到全局变量
                costAnalysisData = result.data;

                // 更新产品选择下拉框
                updateProductSelect(result.products);

                // 显示提示信息
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        请选择要查看的产品
                    </div>
                `;

            } catch (error) {
                console.error('加载成本分析数据失败:', error);
                const container = document.getElementById('costAnalysisContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            加载成本分析数据失败: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // 更新产品选择下拉框
        function updateProductSelect(products) {
            const select = document.getElementById('productSelect');
            if (!select) return;

            select.innerHTML = '<option value="">请选择产品...</option>';
            
            if (products && products.length > 0) {
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.product_code;
                    option.textContent = product.product_name;
                    select.appendChild(option);
                });
            }

            // 添加选择事件监听
            select.onchange = showSelectedProductCost;
        }

        // 显示选中产品的成本分析
        function showSelectedProductCost() {
            const container = document.getElementById('costAnalysisContainer');
            const select = document.getElementById('productSelect');
            if (!container || !select) return;

            const selectedCode = select.value;
            if (!selectedCode || !costAnalysisData) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        请选择要查看的产品
                    </div>
                `;
                return;
            }

            const product = costAnalysisData.find(p => p.product_code === selectedCode);
            if (!product) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        未找到所选产品的成本数据
                    </div>
                `;
                return;
            }

            // 过滤掉金额为0的成本项
            const validCosts = product.cost_breakdown.filter(item => item.value > 0);

            // 创建成本分析卡片
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-7">
                        <div class="cost-chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="table-responsive">
                            <table class="table table-sm cost-summary">
                                <tbody>
                                    ${validCosts.map(item => `
                                        <tr>
                                            <td>
                                                <i class="bi ${getCostIcon(item.name)}"></i>
                                                <span class="${getCostClass(item.name)}">${item.name}</span>
                                            </td>
                                            <td class="text-end">
                                                <div class="fw-bold ${getCostClass(item.name)}">
                                                    ¥${item.value.toFixed(2)}
                                                </div>
                                                <div class="cost-percentage">${item.percentage.toFixed(2)}%</div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    <tr class="table-secondary">
                                        <td>
                                            <i class="bi bi-calculator"></i>
                                            总成本
                                        </td>
                                        <td class="text-end fw-bold">¥${product.total_cost.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // 创建饼图
            const ctx = document.getElementById('costChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: validCosts.map(item => item.name),
                        datasets: [{
                            data: validCosts.map(item => item.value),
                            backgroundColor: validCosts.map(item => getCostColor(item.name)),
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 12
                                    },
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const percentage = (value / product.total_cost * 100).toFixed(2);
                                        return `${context.label}: ¥${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // 获取成本类型对应的图标
        function getCostIcon(costType) {
            const icons = {
                '材料成本': 'bi-box',
                '人工成本': 'bi-person-workspace',
                '管理成本': 'bi-building',
                '运输成本': 'bi-truck',
                '其他成本': 'bi-three-dots'
            };
            return icons[costType] || 'bi-circle';
        }

        // 获取成本类型对应的CSS类
        function getCostClass(costType) {
            const classes = {
                '材料成本': 'cost-item-material',
                '人工成本': 'cost-item-labor',
                '管理成本': 'cost-item-management',
                '运输成本': 'cost-item-transport',
                '其他成本': 'cost-item-other'
            };
            return classes[costType] || '';
        }

        // 获取成本类型对应的颜色
        function getCostColor(costType) {
            const colors = {
                '材料成本': 'var(--chart-color-material)',
                '人工成本': 'var(--chart-color-labor)',
                '管理成本': 'var(--chart-color-management)',
                '运输成本': 'var(--chart-color-transport)',
                '其他成本': 'var(--chart-color-other)'
            };
            return colors[costType] || '#999999';
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCostAnalysisReport();
        });

        // 全局变量
        let profitTrendChart = null;

        // 加载盈亏分析数据
        async function loadProfitAnalysis() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const productCode = document.getElementById('productSelect').value;
                
                // 构建查询参数
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (productCode) params.append('product_code', productCode);
                
                const response = await fetch(`/api/profit_analysis?${params.toString()}`);
                const data = await response.json();
                
                if (!data.success) {
                    showAlert('danger', data.error || '加载数据失败');
                    return;
                }
                
                // 更新产品选择下拉框
                updateProductSelect(data.products);
                
                // 更新产品统计表
                updateProductStats(data.product_stats);
                
                // 更新订单明细表
                updateOrderList(data.orders);
                
                // 更新趋势图
                updateProfitTrendChart(data.orders);
                
            } catch (error) {
                console.error('加载盈亏分析数据失败:', error);
                showAlert('danger', '加载数据失败: ' + error.message);
            }
        }

        // 更新产品统计表
        function updateProductStats(stats) {
            const tbody = document.querySelector('#productStatsTable tbody');
            tbody.innerHTML = stats.map(stat => `
                <tr>
                    <td>${stat.product_name} (${stat.product_code})</td>
                    <td>${stat.total_orders}</td>
                    <td>¥${stat.total_sales.toFixed(2)}</td>
                    <td>¥${stat.total_costs.toFixed(2)}</td>
                    <td class="${stat.total_profit >= 0 ? 'text-success' : 'text-danger'}">
                        ¥${stat.total_profit.toFixed(2)}
                    </td>
                    <td class="${stat.avg_profit_rate >= 0 ? 'text-success' : 'text-danger'}">
                        ${stat.avg_profit_rate.toFixed(2)}%
                    </td>
                </tr>
            `).join('');
        }

        // 更新订单列表
        function updateOrderList(orders) {
            const tbody = document.querySelector('#orderProfitTable tbody');
            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td>${order.order_id}</td>
                    <td>${order.product_name}</td>
                    <td>¥${order.total_cost.toFixed(2)}</td>
                    <td>¥${order.sale_price.toFixed(2)}</td>
                    <td class="${order.profit >= 0 ? 'text-success' : 'text-danger'}">
                        ¥${order.profit.toFixed(2)}
                    </td>
                    <td class="${order.profit_rate >= 0 ? 'text-success' : 'text-danger'}">
                        ${order.profit_rate.toFixed(2)}%
                    </td>
                    <td>${new Date(order.order_date).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        // 更新趋势图
        function updateProfitTrendChart(orders) {
            // 按日期分组数据
            const dateGroups = {};
            orders.forEach(order => {
                const date = order.order_date.split('T')[0];
                if (!dateGroups[date]) {
                    dateGroups[date] = {
                        sales: 0,
                        costs: 0,
                        profit: 0
                    };
                }
                dateGroups[date].sales += order.sale_price;
                dateGroups[date].costs += order.total_cost;
                dateGroups[date].profit += order.profit;
            });
            
            // 准备图表数据
            const dates = Object.keys(dateGroups).sort();
            const salesData = dates.map(date => dateGroups[date].sales);
            const costsData = dates.map(date => dateGroups[date].costs);
            const profitData = dates.map(date => dateGroups[date].profit);
            
            // 销毁旧图表
            if (profitTrendChart) {
                profitTrendChart.destroy();
            }
            
            // 创建新图表
            const ctx = document.getElementById('profitTrendChart').getContext('2d');
            profitTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: '销售额',
                            data: salesData,
                            borderColor: '#36A2EB',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true
                        },
                        {
                            label: '成本',
                            data: costsData,
                            borderColor: '#FF6384',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: true
                        },
                        {
                            label: '利润',
                            data: profitData,
                            borderColor: '#4BC0C0',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '销售、成本和利润趋势'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ¥' + context.raw.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '金额 (¥)'
                            }
                        }
                    }
                }
            });
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期范围（最近30天）
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            
            // 加载初始数据
            loadProfitAnalysis();
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化成本计算表单
            const costForm = document.getElementById('costCalculationForm');
            if (costForm) {
                costForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    calculateProductCost();
                });
            }

            // 标签页切换事件
            const tabTriggers = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabTriggers.forEach(trigger => {
                trigger.addEventListener('shown.bs.tab', function (event) {
                    const activeTab = event.target.getAttribute('data-bs-target');
                    console.log('切换到标签页:', activeTab);
                    
                    if (activeTab === '#inventory') {
                        console.log('加载库存数据...');
                        loadInventorySummary();
                    } else if (activeTab === '#cost') {
                        console.log('加载成本数据...');
                        loadProductList();
                        loadCostConfigItems();
                        loadProductCosts();
                    } else if (activeTab === '#bom') {
                        console.log('加载BOM数据...');
                        loadBomList();
                    }
                });
            });

            // 检查当前活动标签页
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                const tabTarget = activeTab.getAttribute('data-bs-target');
                if (tabTarget === '#cost') {
                    loadProductList();
                    loadCostConfigItems();
                    loadProductCosts();
                }
            }
        });

        // 成本计算函数
        async function calculateCost(event) {
            event.preventDefault();
            console.log('开始计算成本...');
            
            const form = event.target;
            const productCode = form.querySelector('#productCode').value;
            const quantity = parseFloat(form.querySelector('#quantity').value) || 1;
            const laborHours = parseFloat(form.querySelector('#laborHours').value) || 0;
            
            console.log('表单数据:', { productCode, quantity, laborHours });
            
            if (!productCode) {
                showAlert('warning', '请选择要计算成本的产品');
                return;
            }
            
            try {
                // 显示加载状态
                const resultDiv = document.getElementById('costResult');
                resultDiv.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm"></div>
                        <p class="text-muted mt-2">正在计算成本...</p>
                    </div>
                `;
                
                // 禁用提交按钮
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                
                console.log('发送API请求...');
                const response = await fetch('/api/calculate_product_cost', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_code: productCode,
                        quantity: quantity,
                        labor_hours: laborHours
                    })
                });
                
                console.log('API响应状态:', response.status);
                const data = await response.json();
                console.log('成本计算结果:', data);
                
                if (data.success) {
                    if (data.cost) {
                        displayCostResult(data.cost);
                        showAlert('success', '成本计算完成');
                        // 刷新成本列表
                        loadProductCosts();
                    } else {
                        resultDiv.innerHTML = '';
                        showAlert('warning', '成本计算结果格式不正确');
                    }
                } else {
                    resultDiv.innerHTML = '';
                    showAlert('danger', data.error || '计算失败');
                }
            } catch (error) {
                console.error('计算成本时出错:', error);
                document.getElementById('costResult').innerHTML = '';
                showAlert('danger', '计算失败: ' + error.message);
            } finally {
                // 重新启用提交按钮
                const submitButton = form.querySelector('button[type="submit"]');
                submitButton.disabled = false;
            }
        }

        // 显示成本计算结果
        function displayCostResult(cost) {
            const resultDiv = document.getElementById('costResult');
            if (!resultDiv || !cost) return;

            // 生成成本明细表格
            let html = `
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">成本计算结果</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">总成本</h6>
                                        <h4 class="mb-0">¥${cost.total_cost.toFixed(2)}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">单位成本</h6>
                                        <h4 class="mb-0">¥${cost.unit_cost.toFixed(2)}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">计算数量</h6>
                                        <h4 class="mb-0">${cost.quantity}</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3">成本明细</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>成本项目</th>
                                        <th class="text-end">金额</th>
                                        <th class="text-end">占比</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cost.cost_details.map(detail => `
                                        <tr>
                                            <td>${detail.name}</td>
                                            <td class="text-end">¥${detail.value.toFixed(2)}</td>
                                            <td class="text-end">${detail.percentage.toFixed(2)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr class="table-light">
                                        <th>总计</th>
                                        <th class="text-end">¥${cost.total_cost.toFixed(2)}</th>
                                        <th class="text-end">100%</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="text-muted small mt-3">
                            计算时间: ${cost.calculation_date}
                        </div>
                    </div>
                </div>
            `;

            resultDiv.innerHTML = html;
        }

        // 显示产品入库模态框
        async function showProductStockModal() {
            try {
                // 加载产品列表
                const response = await fetch('/api/products_with_bom');
                const data = await response.json();
                
                if (data.success) {
                    const select = document.getElementById('stockProductCode');
                    select.innerHTML = '<option value="">请选择产品</option>';
                    
                                data.products.forEach(product => {
                select.innerHTML += `
                    <option value="${product.code}">
                        ${product.display_name}
                    </option>
                `;
                    });
                    
                    // 显示模态框
                    const modal = new bootstrap.Modal(document.getElementById('productStockModal'));
                    modal.show();
                } else {
                    showAlert('danger', '加载产品列表失败');
                }
            } catch (error) {
                console.error('加载产品列表失败:', error);
                showAlert('danger', '加载产品列表失败');
            }
        }

        // 提交产品入库
        async function submitProductStock() {
            const form = document.getElementById('productStockForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const productCode = document.getElementById('stockProductCode').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const unitPrice = parseFloat(document.getElementById('stockUnitPrice').value) || null;
            const notes = document.getElementById('stockNotes').value;
            
            try {
                const response = await fetch('/api/update_product_stock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_code: productCode,
                        quantity: quantity,
                        unit_price: unitPrice,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', '产品入库成功');
                    bootstrap.Modal.getInstance(document.getElementById('productStockModal')).hide();
                    loadInventorySummary(); // 刷新库存数据
                } else {
                    showAlert('danger', result.error || '入库失败');
                }
            } catch (error) {
                console.error('产品入库失败:', error);
                showAlert('danger', '入库失败: ' + error.message);
            }
        }

        // 显示分类库存统计
        function displayCategoryStats(data) {
            const container = document.getElementById('categoryStats');
            if (!container) return;

            let html = '<div class="row g-3">';
            
            // 按类别分组显示
            const categories = {
                '原材料': {
                    icon: 'bi-box-seam',
                    color: 'primary',
                    items: []
                },
                '包装': {
                    icon: 'bi-box2',
                    color: 'success',
                    items: []
                },
                '配件': {
                    icon: 'bi-tools',
                    color: 'info',
                    items: []
                },
                '产品': {
                    icon: 'bi-box2-heart',
                    color: 'warning',
                    items: []
                }
            };
            
            // 分类数据
            data.forEach(item => {
                if (categories[item.item_category]) {
                    categories[item.item_category].items.push(item);
                }
            });
            
            // 生成HTML
            Object.entries(categories).forEach(([category, info]) => {
                const items = info.items;
                if (items.length === 0) return;
                
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-header bg-${info.color} text-white">
                                <h6 class="mb-0">
                                    <i class="bi ${info.icon}"></i> ${category}库存
                                    <span class="badge bg-light text-dark float-end">
                                        ${items.length}个
                                    </span>
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>编码</th>
                                                <th>名称</th>
                                                <th class="text-end">库存</th>
                                                <th class="text-end">单价</th>
                                                <th class="text-end">总值</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${items.map(item => `
                                                <tr>
                                                    <td><small>${item.item_code}</small></td>
                                                    <td>${item.item_name}</td>
                                                    <td class="text-end">
                                                        ${item.current_stock}
                                                        <small class="text-muted">${item.unit}</small>
                                                        ${item.current_stock <= item.low_stock_threshold ? 
                                                            '<span class="badge bg-danger ms-1">库存不足</span>' : 
                                                            (item.current_stock <= item.warning_stock_threshold ? 
                                                                '<span class="badge bg-warning ms-1">库存偏低</span>' : '')}
                                                    </td>
                                                    <td class="text-end">¥${item.weighted_avg_price.toFixed(2)}</td>
                                                    <td class="text-end">¥${item.total_value.toFixed(2)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot class="table-light">
                                            <tr>
                                                <td colspan="2">
                                                    <strong>小计</strong>
                                                </td>
                                                <td class="text-end">
                                                    ${items.reduce((sum, item) => sum + item.current_stock, 0).toFixed(0)}
                                                    <small class="text-muted">个</small>
                                                </td>
                                                <td></td>
                                                <td class="text-end">
                                                    <strong>¥${items.reduce((sum, item) => sum + item.total_value, 0).toFixed(2)}</strong>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // 显示库存不足提醒
        function displayLowStockItems(data) {
            const container = document.getElementById('lowStockItems');
            if (!container) return;
            
            // 筛选库存不足的物料
            const lowStockItems = data.filter(item => 
                item.current_stock <= item.low_stock_threshold
            );
            
            if (lowStockItems.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success mb-0">
                        <i class="bi bi-check-circle"></i> 当前没有库存不足的物料
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="list-group list-group-flush">
                    ${lowStockItems.map(item => `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${item.item_name}</h6>
                                    <small class="text-muted">${item.item_code}</small>
                                </div>
                                <span class="badge bg-${item.current_stock <= item.low_stock_threshold ? 'danger' : 'warning'}">
                                    ${item.current_stock} / ${item.warning_stock_threshold}
                                </span>
                            </div>
                            <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-${item.current_stock <= item.low_stock_threshold ? 'danger' : 'warning'}"
                                     role="progressbar"
                                     style="width: ${(item.current_stock / item.warning_stock_threshold * 100).toFixed(0)}%">
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html> 